<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">347</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Migrating the Python CVS to Subversion</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0347.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Martin von LÃ¶wis &lt;martin&#32;&#97;t&#32;v.loewis.de&gt;</td>
</tr>
<tr class="field"><th class="field-name">Discussions-To:</th><td class="field-body">&lt;<a class="reference external" href="mailto:python-dev&#64;python.org?subject=PEP%20347">python-dev&#32;&#97;t&#32;python.org</a>&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Process</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">14-Jul-2004</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">14-Jul-2004</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id2">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id3">Rationale</a><ul>
<li><a class="reference internal" href="#moving-to-subversion" id="id4">Moving to Subversion</a></li>
<li><a class="reference internal" href="#moving-to-python-org" id="id5">Moving to python.org</a></li>
</ul>
</li>
<li><a class="reference internal" href="#migration-procedure" id="id6">Migration Procedure</a><ul>
<li><a class="reference internal" href="#collect-ssh-keys" id="id7">Collect SSH keys</a></li>
<li><a class="reference internal" href="#administrator-access" id="id8">Administrator Access</a></li>
<li><a class="reference internal" href="#downloading-the-cvs-repository" id="id9">Downloading the CVS Repository</a></li>
<li><a class="reference internal" href="#converting-the-cvs-repository" id="id10">Converting the CVS Repository</a></li>
<li><a class="reference internal" href="#publish-the-repository" id="id11">Publish the Repository</a></li>
<li><a class="reference internal" href="#disable-cvs" id="id12">Disable CVS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#discussion" id="id13">Discussion</a></li>
<li><a class="reference internal" href="#copyright" id="id14">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id2">Abstract</a></h1>
<p>The Python source code is currently managed in a CVS repository on
sourceforge.net.  This PEP proposes to move it to a Subversion
repository on svn.python.org.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id3">Rationale</a></h1>
<p>This change has two aspects: moving from CVS to Subversion, and moving
from SourceForge to python.org.  For each, a rationale will be given.</p>
<div class="section" id="moving-to-subversion">
<h2><a class="toc-backref" href="#id4">Moving to Subversion</a></h2>
<p>CVS has a number of limitations that have been eliminated by
Subversion.  For the development of Python, the most notable
improvements are:</p>
<ul class="simple">
<li>the ability to rename files and directories, and to remove
directories, while keeping the history of these files.</li>
<li>support for change sets (sets of correlated changes to multiple
files) through global revision numbers.  Change sets are
transactional.</li>
<li>atomic, fast tagging: a cvs tag might take many minutes; a
Subversion tag (svn cp) will complete quickly, and atomically.
Likewise, branches are very efficient.</li>
<li>support for offline diffs, which is useful when creating patches.</li>
</ul>
</div>
<div class="section" id="moving-to-python-org">
<h2><a class="toc-backref" href="#id5">Moving to python.org</a></h2>
<p>SourceForge has kindly provided an important infrastructure for the
past years.  Unfortunately, the attention that SF received has also
caused repeated overload situations in the past, to which the SF
operators could not always respond in a timely manner.  In particular,
for CVS, they had to reduce the load on the primary CVS server by
introducing a second, read-only CVS server for anonymous access.  This
server is regularly synchronized, but lags behind the read-write CVS
repository between synchronizations.  As a result, users without
commit access can see recent changes to the repository only after a
delay.</p>
<p>On python.org, it would be possible to make the repository accessible
for anonymous access.</p>
</div>
</div>
<div class="section" id="migration-procedure">
<h1><a class="toc-backref" href="#id6">Migration Procedure</a></h1>
<p>To move the Python CVS repository, the following steps need to be
executed.  The steps are elaborated upon in the following sections.</p>
<ol class="arabic simple">
<li>Collect SSH keys for all current committers, along with usernames
to appear in commit messages.</li>
<li>At the beginning of the migration, announce that the repository on
SourceForge closed.</li>
<li>24 hours after the last commit, download the CVS repository.</li>
<li>Convert the CVS repository into a Subversion repository.</li>
<li>Publish the repository with write access for committers, and
read-only anonymous access.</li>
<li>Disable CVS access on SF.</li>
</ol>
<div class="section" id="collect-ssh-keys">
<h2><a class="toc-backref" href="#id7">Collect SSH keys</a></h2>
<p>After some discussion, svn+ssh was selected as the best method
for write access to the repository. Developers can continue to
use their SSH keys, but they must be installed on python.org.</p>
<p>In order to avoid having to create a new Unix user for each
developer, a single account should be used, with command=
attributes in the authorized_keys files.</p>
<p>The lines in the authorized_keys file should read like this
(wrapped for better readability):</p>
<pre class="literal-block">
command=&quot;/usr/bin/svnserve --root=/svnroot -t
--tunnel-user='&lt;username&gt;'&quot;,no-port-forwarding,
no-X11-forwarding,no-agent-forwarding,no-pty
ssh-dss &lt;key&gt; &lt;comment&gt;
</pre>
<p>As the usernames, the real names should be used instead of
the SF account names, so that people can be better identified
in log messages.</p>
</div>
<div class="section" id="administrator-access">
<h2><a class="toc-backref" href="#id8">Administrator Access</a></h2>
<p>Administrator access to the pythondev account should be granted
to all current admins of the Python SF project. To distinguish
between shell login and svnserve login, admins need to maintain
two keys. Using OpenSSH, the following procedure can be
used to create a second key:</p>
<pre class="literal-block">
cd .ssh
ssh-keygen -t DSA -f pythondev -C &lt;user&gt;&#64;pythondev
vi config
</pre>
<p>In the config file, the following lines need to be added:</p>
<pre class="literal-block">
Host pythondev
  Hostname dinsdale.python.org
  User pythondev
  IdentityFile ~/.ssh/pythondev
</pre>
<p>Then, shell login becomes possible through &quot;ssh pythondev&quot;.</p>
</div>
<div class="section" id="downloading-the-cvs-repository">
<h2><a class="toc-backref" href="#id9">Downloading the CVS Repository</a></h2>
<p>The CVS repository can be downloaded from</p>
<blockquote>
<a class="reference external" href="http://cvs.sourceforge.net/cvstarballs/python-cvsroot.tar.bz2">http://cvs.sourceforge.net/cvstarballs/python-cvsroot.tar.bz2</a></blockquote>
<p>Since this tarball is generated only once a day, some time must pass
after the repository freeze before the tarball can be picked up.  It
should be verified that the last commit, as recorded on the
python-commits mailing list, is indeed included in the tarball.</p>
<p>After the conversion, the converted CVS tarball should be kept
forever on www.python.org/archive/python-cvsroot-&lt;date&gt;.tar.bz2</p>
</div>
<div class="section" id="converting-the-cvs-repository">
<h2><a class="toc-backref" href="#id10">Converting the CVS Repository</a></h2>
<p>The Python CVS repository contains two modules: distutils and python.
The python module is further structured into dist and nondist,
where dist only contains src (the python code proper). nondist
contains various subdirectories.</p>
<p>These should be reorganized in the Subversion repository to get
shorter URLs, following the &lt;project&gt;/{trunk,tags,branches}
structure.  A project will be created for each nondist directory,
plus for src (called python), plus distutils.  Reorganizing the
repository is best done in the CVS tree, as shown below.</p>
<p>The fsfs backend should be used as the repository format (which
requires Subversion 1.1).  The fsfs backend has the advantage of being
more backup-friendly, as it allows incremental repository backups,
without requiring any dump commands to be run.</p>
<p>The conversion should be done using the cvs2svn utility, available
e.g. in the cvs2svn Debian package.  As cvs2svn does not currently
support the project/trunk structure, each project needs to be
converted separately.  To get each conversion result into a separate
directory in the target repository, svnadmin load must be used.</p>
<p>Subversion has a different view on binary-vs-text files than CVS.
To correctly carry the CVS semantics forward, svn:eol-style should
be set to native on all files that are not marked binary in the
CVS.</p>
<p>In summary, the conversion script is:</p>
<pre class="literal-block">
#!/bin/sh
rm cvs2svn-*
rm -rf python py.new
tar xjf python-cvsroot.tar.bz2
rm -rf python/CVSROOT
svnadmin create --fs-type fsfs py.new
mv python/python python/orig
mv python/orig/dist/src python/python
mv python/orig/nondist/* python
# nondist/nondist is empty
rmdir python/nondist
rm -rf python/orig
for a in python/*
do
  b=`basename $a`
  cvs2svn -q --dump-only --encoding=latin1 --force-branch=cnri-16-start \
  --force-branch=descr-branch --force-branch=release152p1-patches \
  --force-tag=r16b1 $a
  svn mkdir -m&quot;Conversion to SVN&quot; file:///`pwd`/py.new/$b
  svnadmin load -q --parent-dir $b py.new &lt; cvs2svn-dump
  rm cvs2svn-dump
done
</pre>
<p>Sample results of this conversion are available at</p>
<blockquote>
<a class="reference external" href="http://www.dcl.hpi.uni-potsdam.de/pysvn/">http://www.dcl.hpi.uni-potsdam.de/pysvn/</a></blockquote>
</div>
<div class="section" id="publish-the-repository">
<h2><a class="toc-backref" href="#id11">Publish the Repository</a></h2>
<p>The repository should be published at <a class="reference external" href="http://svn.python.org/projects">http://svn.python.org/projects</a>.
Read-write access should be granted to all current SF committers
through svn+ssh://pythondev&#64;svn.python.org/;
read-only anonymous access through WebDAV should also be
granted.</p>
<p>As an option, websvn (available e.g. from the Debian websvn package)
could be provided. Unfortunately, in the test installation, websvn
breaks because it runs out of memory.</p>
<p>The current SF project admins should get write access to the
authorized_keys2 file of the pythondev account.</p>
</div>
<div class="section" id="disable-cvs">
<h2><a class="toc-backref" href="#id12">Disable CVS</a></h2>
<p>It appears that CVS cannot be disabled entirely.  Only the user
interface can be removed from the project page; the repository itself
remains available.  If desired, write access to the python and
distutils modules can be disabled through a CVS commitinfo entry.</p>
</div>
</div>
<div class="section" id="discussion">
<h1><a class="toc-backref" href="#id13">Discussion</a></h1>
<p>Several alternatives had been suggested to the procedure above.
The rejected alternatives are shortly discussed here:</p>
<ul>
<li><p class="first">create multiple repositories, one for python and one for
distutils. This would have allowed even shorter URLs, but
was rejected because a single repository supports moving code
across projects.</p>
</li>
<li><p class="first">Several people suggested to create the project/trunk structure
through standard cvs2svn, followed by renames. This would have
the disadvantage that old revisions use different path names
than recent revisions; the suggested approach through dump files
works without renames.</p>
</li>
<li><p class="first">Several people also expressed concern about the administrative
overhead that hosting the repository on python.org would cause
to pydotorg admins.  As a specific alternative, BerliOS has been
suggested.  The pydotorg admins themselves haven't objected
to the additional workload; migrating the repository again if
they get overworked is an option.</p>
</li>
<li><p class="first">Different authentication strategies were discussed. As
alternatives to svn+ssh were suggested</p>
<ul class="simple">
<li>Subversion over WebDAV, using SSL and basic authentication,
with pydotorg-generated passwords mailed to the user. People
did not like that approach, since they would need to store
the password on disk (because they can't remember it); this
is a security risk.</li>
<li>Subversion over WebDAV, using SSL client certificates. This would
work, but would require us to administer a certificate authority.</li>
</ul>
</li>
<li><p class="first">Instead of hosting this on python.org, people suggested hosting
it elsewhere. One issue is whether this alternative should be
free or commercial; several people suggested it should better
be commercial, to reduce the load on the volunteers. In
particular:</p>
<ul>
<li><p class="first">Greg Stein suggested <a class="reference external" href="http://www.wush.net/subversion.php">http://www.wush.net/subversion.php</a>. They
offer 5 GB for $90/month, with 200 GB download/month.
The data is on a RAID drive and fully backed up. Anonymous
access and email commit notifications are supported. wush.net
elaborated the following details:</p>
<ul class="simple">
<li>The machine would be a Virtuozzo Virtual Private Server (VPS),
hosted at PowerVPS.</li>
<li>The default repository URL would be <a class="reference external" href="http://python.wush.net/svn/projectname/">http://python.wush.net/svn/projectname/</a>,
but anything else could be arranged</li>
<li>we would get SSH login to the machine, with sudo capabilities.</li>
<li>They have a Web interface for management of the various SVN
repositories that we want to host, and to manage user accounts.
While svn+ssh would be supported, the user interface does not
yet support it.</li>
<li>For offsite mirroring/backup, they suggest to use rsync
instead of download of repository tarballs.</li>
</ul>
<p>Bob Ippolito reported that they had used wush.net for a
commercial project for about 6 months, after which time they
left wush.net, because the service was down for three days,
with nobody reachable, and no explanation when it came back.</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id14">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>


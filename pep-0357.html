<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">357</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Allowing Any Object to be Used for Slicing</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0357.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Travis Oliphant &lt;oliphant&#32;&#97;t&#32;ee.byu.edu&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">09-Feb-2006</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">2.5</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id3">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id4">Rationale</a></li>
<li><a class="reference internal" href="#proposal" id="id5">Proposal</a></li>
<li><a class="reference internal" href="#specification" id="id6">Specification</a></li>
<li><a class="reference internal" href="#implementation-plan" id="id7">Implementation Plan</a></li>
<li><a class="reference internal" href="#discussion-questions" id="id8">Discussion Questions</a><ul>
<li><a class="reference internal" href="#speed" id="id9">Speed</a></li>
<li><a class="reference internal" href="#why-not-use-nb-int-which-is-already-there" id="id10">Why not use <tt class="docutils literal">nb_int</tt> which is already there?</a></li>
<li><a class="reference internal" href="#why-the-name-index" id="id11">Why the name <tt class="docutils literal">__index__</tt>?</a></li>
<li><a class="reference internal" href="#why-return-pyobject-from-nb-index" id="id12">Why return <tt class="docutils literal">PyObject *</tt> from <tt class="docutils literal">nb_index</tt>?</a></li>
<li><a class="reference internal" href="#why-can-t-index-return-any-object-with-the-nb-index-method" id="id13">Why can't <tt class="docutils literal">__index__</tt> return any object with the <tt class="docutils literal">nb_index</tt> method?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation" id="id14">Reference Implementation</a></li>
<li><a class="reference internal" href="#references" id="id15">References</a></li>
<li><a class="reference internal" href="#copyright" id="id16">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id3">Abstract</a></h1>
<p>This PEP proposes adding an <tt class="docutils literal">nb_index</tt> slot in <tt class="docutils literal">PyNumberMethods</tt> and an
<tt class="docutils literal">__index__</tt> special method so that arbitrary objects can be used
whenever integers are explicitly needed in Python, such as in slice
syntax (from which the slot gets its name).</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id4">Rationale</a></h1>
<p>Currently integers and long integers play a special role in
slicing in that they are the only objects allowed in slice
syntax. In other words, if X is an object implementing the
sequence protocol, then <tt class="docutils literal">X[obj1:obj2]</tt> is only valid if <tt class="docutils literal">obj1</tt> and
<tt class="docutils literal">obj2</tt> are both integers or long integers.  There is no way for <tt class="docutils literal">obj1</tt>
and <tt class="docutils literal">obj2</tt> to tell Python that they could be reasonably used as
indexes into a sequence.  This is an unnecessary limitation.</p>
<p>In NumPy, for example, there are 8 different integer scalars
corresponding to unsigned and signed integers of 8, 16, 32, and 64
bits.  These type-objects could reasonably be used as integers in
many places where Python expects true integers but cannot inherit from
the Python integer type because of incompatible memory layouts.
There should be some way to be able to tell Python that an object can
behave like an integer.</p>
<p>It is not possible to use the <tt class="docutils literal">nb_int</tt> (and <tt class="docutils literal">__int__</tt> special method)
for this purpose because that method is used to <em>coerce</em> objects
to integers.  It would be inappropriate to allow every object that
can be coerced to an integer to be used as an integer everywhere
Python expects a true integer.  For example, if <tt class="docutils literal">__int__</tt> were used
to convert an object to an integer in slicing, then float objects
would be allowed in slicing and <tt class="docutils literal">x[3.2:5.8]</tt> would not raise an error
as it should.</p>
</div>
<div class="section" id="proposal">
<h1><a class="toc-backref" href="#id5">Proposal</a></h1>
<p>Add an <tt class="docutils literal">nb_index</tt> slot to <tt class="docutils literal">PyNumberMethods</tt>, and a corresponding
<tt class="docutils literal">__index__</tt> special method.  Objects could define a function to
place in the <tt class="docutils literal">nb_index</tt> slot that returns a Python integer
(either an int or a long). This integer can
then be appropriately converted to a <tt class="docutils literal">Py_ssize_t</tt> value whenever
Python needs one such as in <tt class="docutils literal">PySequence_GetSlice</tt>,
<tt class="docutils literal">PySequence_SetSlice</tt>, and <tt class="docutils literal">PySequence_DelSlice</tt>.</p>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id6">Specification</a></h1>
<ol class="arabic">
<li><p class="first">The <tt class="docutils literal">nb_index</tt> slot will have the following signature:</p>
<pre class="literal-block">
PyObject *index_func (PyObject *self)
</pre>
<p>The returned object must be a Python <tt class="docutils literal">IntType</tt> or
Python <tt class="docutils literal">LongType</tt>. NULL should be returned on
error with an appropriate error set.</p>
</li>
<li><p class="first">The <tt class="docutils literal">__index__</tt> special method will have the signature:</p>
<pre class="literal-block">
def __index__(self):
    return obj
</pre>
<p>where obj must be either an int or a long.</p>
</li>
<li><p class="first">3 new abstract C-API functions will be added</p>
<ol class="loweralpha">
<li><p class="first">The first checks to see if the object supports the index
slot and if it is filled in.</p>
<pre class="literal-block">
int PyIndex_Check(obj)
</pre>
<p>This will return true if the object defines the <tt class="docutils literal">nb_index</tt>
slot.</p>
</li>
<li><p class="first">The second is a simple wrapper around the <tt class="docutils literal">nb_index</tt> call that
raises <tt class="docutils literal">PyExc_TypeError</tt> if the call is not available or if it
doesn't return an int or long.  Because the
<tt class="docutils literal">PyIndex_Check</tt> is performed inside the <tt class="docutils literal">PyNumber_Index</tt> call
you can call it directly and manage any error rather than
check for compatibility first.</p>
<pre class="literal-block">
PyObject *PyNumber_Index (PyObject *obj)
</pre>
</li>
<li><p class="first">The third call helps deal with the common situation of
actually needing a <tt class="docutils literal">Py_ssize_t</tt> value from the object to use for
indexing or other needs.</p>
<pre class="literal-block">
Py_ssize_t PyNumber_AsSsize_t(PyObject *obj, PyObject *exc)
</pre>
<p>The function calls the <tt class="docutils literal">nb_index</tt> slot of obj if it is
available and then converts the returned Python integer into
a <tt class="docutils literal">Py_ssize_t</tt> value.  If this goes well, then the value is
returned.  The second argument allows control over what
happens if the integer returned from <tt class="docutils literal">nb_index</tt> cannot fit
into a <tt class="docutils literal">Py_ssize_t</tt> value.</p>
<p>If exc is NULL, then the returned value will be clipped to
<tt class="docutils literal">PY_SSIZE_T_MAX</tt> or <tt class="docutils literal">PY_SSIZE_T_MIN</tt> depending on whether the
<tt class="docutils literal">nb_index</tt> slot of obj returned a positive or negative
integer.  If exc is non-NULL, then it is the error object
that will be set to replace the <tt class="docutils literal">PyExc_OverflowError</tt> that was
raised when the Python integer or long was converted to <tt class="docutils literal">Py_ssize_t</tt>.</p>
</li>
</ol>
</li>
<li><p class="first">A new <tt class="docutils literal">operator.index(obj)</tt> function will be added that calls
equivalent of <tt class="docutils literal">obj.__index__()</tt> and raises an error if obj does not implement
the special method.</p>
</li>
</ol>
</div>
<div class="section" id="implementation-plan">
<h1><a class="toc-backref" href="#id7">Implementation Plan</a></h1>
<ol class="arabic simple">
<li>Add the <tt class="docutils literal">nb_index</tt> slot in <tt class="docutils literal">object.h</tt> and modify <tt class="docutils literal">typeobject.c</tt> to
create the <tt class="docutils literal">__index__</tt> method</li>
<li>Change the <tt class="docutils literal">ISINT</tt> macro in <tt class="docutils literal">ceval.c</tt> to <tt class="docutils literal">ISINDEX</tt> and alter it to
accommodate objects with the index slot defined.</li>
<li>Change the <tt class="docutils literal">_PyEval_SliceIndex</tt> function to accommodate objects
with the index slot defined.</li>
<li>Change all builtin objects (e.g. lists) that use the <tt class="docutils literal">as_mapping</tt>
slots for subscript access and use a special-check for integers to
check for the slot as well.</li>
<li>Add the <tt class="docutils literal">nb_index</tt> slot to integers and long_integers
(which just return themselves)</li>
<li>Add <tt class="docutils literal">PyNumber_Index</tt> C-API to return an integer from any
Python Object that has the <tt class="docutils literal">nb_index</tt> slot.</li>
<li>Add the <tt class="docutils literal">operator.index(x)</tt> function.</li>
<li>Alter <tt class="docutils literal">arrayobject.c</tt> and <tt class="docutils literal">mmapmodule.c</tt> to use the new C-API for their
sub-scripting and other needs.</li>
<li>Add unit-tests</li>
</ol>
</div>
<div class="section" id="discussion-questions">
<h1><a class="toc-backref" href="#id8">Discussion Questions</a></h1>
<div class="section" id="speed">
<h2><a class="toc-backref" href="#id9">Speed</a></h2>
<p>Implementation should not slow down Python because integers and long
integers used as indexes will complete in the same number of
instructions.  The only change will be that what used to generate
an error will now be acceptable.</p>
</div>
<div class="section" id="why-not-use-nb-int-which-is-already-there">
<h2><a class="toc-backref" href="#id10">Why not use <tt class="docutils literal">nb_int</tt> which is already there?</a></h2>
<p>The <tt class="docutils literal">nb_int</tt> method is used for coercion and so means something
fundamentally different than what is requested here.  This PEP
proposes a method for something that <em>can</em> already be thought of as
an integer communicate that information to Python when it needs an
integer.  The biggest example of why using <tt class="docutils literal">nb_int</tt> would be a bad
thing is that float objects already define the <tt class="docutils literal">nb_int</tt> method, but
float objects <em>should not</em> be used as indexes in a sequence.</p>
</div>
<div class="section" id="why-the-name-index">
<h2><a class="toc-backref" href="#id11">Why the name <tt class="docutils literal">__index__</tt>?</a></h2>
<p>Some questions were raised regarding the name <tt class="docutils literal">__index__</tt> when other
interpretations of the slot are possible.  For example, the slot
can be used any time Python requires an integer internally (such
as in <tt class="docutils literal">&quot;mystring&quot; * 3</tt>).  The name was suggested by Guido because
slicing syntax is the biggest reason for having such a slot and
in the end no better name emerged. See the discussion thread <a class="footnote-reference" href="#id2" id="id1">[1]</a>
for examples of names that were suggested such as &quot;<tt class="docutils literal">__discrete__</tt>&quot; and
&quot;<tt class="docutils literal">__ordinal__</tt>&quot;.</p>
</div>
<div class="section" id="why-return-pyobject-from-nb-index">
<h2><a class="toc-backref" href="#id12">Why return <tt class="docutils literal">PyObject *</tt> from <tt class="docutils literal">nb_index</tt>?</a></h2>
<p>Initially <tt class="docutils literal">Py_ssize_t</tt> was selected as the return type for the
<tt class="docutils literal">nb_index</tt> slot.  However, this led to an inability to track and
distinguish overflow and underflow errors without ugly and brittle
hacks. As the <tt class="docutils literal">nb_index</tt> slot is used in at least 3 different ways
in the Python core (to get an integer, to get a slice end-point,
and to get a sequence index), there is quite a bit of flexibility
needed to handle all these cases.  The importance of having the
necessary flexibility to handle all the use cases is critical.
For example, the initial implementation that returned <tt class="docutils literal">Py_ssize_t</tt> for
<tt class="docutils literal">nb_index</tt> led to the discovery that on a 32-bit machine with &gt;=2GB of RAM
<tt class="docutils literal">s = 'x' * <span class="pre">(2**100)</span></tt> works but <tt class="docutils literal">len(s)</tt> was clipped at 2147483647.
Several fixes were suggested but eventually it was decided that
<tt class="docutils literal">nb_index</tt> needed to return a Python Object similar to the <tt class="docutils literal">nb_int</tt>
and <tt class="docutils literal">nb_long</tt> slots in order to handle overflow correctly.</p>
</div>
<div class="section" id="why-can-t-index-return-any-object-with-the-nb-index-method">
<h2><a class="toc-backref" href="#id13">Why can't <tt class="docutils literal">__index__</tt> return any object with the <tt class="docutils literal">nb_index</tt> method?</a></h2>
<p>This would allow infinite recursion in many different ways that are not
easy to check for.  This restriction is similar to the requirement that
<tt class="docutils literal">__nonzero__</tt> return an int or a bool.</p>
</div>
</div>
<div class="section" id="reference-implementation">
<h1><a class="toc-backref" href="#id14">Reference Implementation</a></h1>
<p>Submitted as patch 1436368 to SourceForge.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id15">References</a></h1>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><p class="first">Travis Oliphant, PEP for adding an sq_index slot so that any object, a
or b, can be used in X[a:b] notation,</p>
<p class="last"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2006-February/thread.html#60594">https://mail.python.org/pipermail/python-dev/2006-February/thread.html#60594</a></p>
</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id16">Copyright</a></h1>
<p>This document is placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>


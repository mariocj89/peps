<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">406</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Improved Encapsulation of Import State</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0406.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Nick Coghlan &lt;ncoghlan&#32;&#97;t&#32;gmail.com&gt;, Greg Slodkowicz &lt;jergosh&#32;&#97;t&#32;gmail.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Withdrawn</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">4-Jul-2011</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.4</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">31-Jul-2011, 13-Nov-2011, 4-Dec-2011</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id9">Abstract</a></li>
<li><a class="reference internal" href="#pep-withdrawal" id="id10">PEP Withdrawal</a></li>
<li><a class="reference internal" href="#rationale" id="id11">Rationale</a></li>
<li><a class="reference internal" href="#proposal" id="id12">Proposal</a></li>
<li><a class="reference internal" href="#specification" id="id13">Specification</a><ul>
<li><a class="reference internal" href="#importengine-api" id="id14">ImportEngine API</a></li>
<li><a class="reference internal" href="#global-variables" id="id15">Global variables</a></li>
<li><a class="reference internal" href="#no-changes-to-finder-loader-interfaces" id="id16">No changes to finder/loader interfaces</a></li>
</ul>
</li>
<li><a class="reference internal" href="#open-issues" id="id17">Open Issues</a><ul>
<li><a class="reference internal" href="#api-design-for-falling-back-to-global-import-state" id="id18">API design for falling back to global import state</a></li>
<li><a class="reference internal" href="#builtin-and-extension-modules-must-be-process-global" id="id19">Builtin and extension modules must be process global</a></li>
<li><a class="reference internal" href="#scope-of-substitution" id="id20">Scope of substitution</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation" id="id21">Reference Implementation</a></li>
<li><a class="reference internal" href="#references" id="id22">References</a></li>
<li><a class="reference internal" href="#copyright" id="id23">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id9">Abstract</a></h1>
<p>This PEP proposes the introduction of a new 'ImportEngine' class as part of
<tt class="docutils literal">importlib</tt> which would encapsulate all state related to importing modules
into a single object. Creating new instances of this object would then provide
an alternative to completely replacing the built-in implementation of the
import statement, by overriding the <tt class="docutils literal">__import__()</tt> function. To work with
the builtin import functionality and importing via import engine objects,
this PEP proposes a context management based approach to temporarily replacing
the global import state.</p>
<p>The PEP also proposes inclusion of a <tt class="docutils literal">GlobalImportEngine</tt> subclass and a
globally accessible instance of that class, which &quot;writes through&quot; to the
process global state. This provides a backwards compatible bridge between the
proposed encapsulated API and the legacy process global state, and allows
straightforward support for related state updates (e.g. selectively
invalidating path cache entries when <tt class="docutils literal">sys.path</tt> is modified).</p>
</div>
<div class="section" id="pep-withdrawal">
<h1><a class="toc-backref" href="#id10">PEP Withdrawal</a></h1>
<p>The import system has seen substantial changes since this PEP was originally
written, as part of <a class="reference external" href="/dev/peps/pep-0420">PEP 420</a> in Python 3.3 and <a class="reference external" href="/dev/peps/pep-0451">PEP 451</a> in Python 3.4.</p>
<p>While providing an encapsulation of the import state is still highly
desirable, it is better tackled in a new PEP using <a class="reference external" href="/dev/peps/pep-0451">PEP 451</a> as a foundation,
and permitting only the use of <a class="reference external" href="/dev/peps/pep-0451">PEP 451</a> compatible finders and loaders (as
those avoid many of the issues of direct manipulation of global state
associated with the previous loader API).</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id11">Rationale</a></h1>
<p>Currently, most state related to the import system is stored as module level
attributes in the <tt class="docutils literal">sys</tt> module. The one exception is the import lock, which
is not accessible directly, but only via the related functions in the <tt class="docutils literal">imp</tt>
module. The current process global import state comprises:</p>
<ul class="simple">
<li>sys.modules</li>
<li>sys.path</li>
<li>sys.path_hooks</li>
<li>sys.meta_path</li>
<li>sys.path_importer_cache</li>
<li>the import lock (imp.lock_held()/acquire_lock()/release_lock())</li>
</ul>
<p>Isolating this state would allow multiple import states to be
conveniently stored within a process. Placing the import functionality
in a self-contained object would also allow subclassing to add additional
features (e.g. module import notifications or fine-grained control
over which modules can be imported). The engine would also be
subclassed to make it possible to use the import engine API to
interact with the existing process-global state.</p>
<p>The namespace PEPs (especially <a class="reference external" href="/dev/peps/pep-0402">PEP 402</a>) raise a potential need for
<em>additional</em> process global state, in order to correctly update package paths
as <tt class="docutils literal">sys.path</tt> is modified.</p>
<p>Finally, providing a coherent object for all this state makes it feasible to
also provide context management features that allow the import state to be
temporarily substituted.</p>
</div>
<div class="section" id="proposal">
<h1><a class="toc-backref" href="#id12">Proposal</a></h1>
<p>We propose introducing an ImportEngine class to encapsulate import
functionality. This includes an <tt class="docutils literal">__import__()</tt> method which can
be used as an alternative to the built-in <tt class="docutils literal">__import__()</tt> when
desired and also an <tt class="docutils literal">import_module()</tt> method, equivalent to
<tt class="docutils literal">importlib.import_module()</tt> <a class="footnote-reference" href="#id7" id="id1">[3]</a>.</p>
<p>Since there are global import state invariants that are assumed and should be
maintained, we introduce a <tt class="docutils literal">GlobalImportState</tt> class with an interface
identical to <tt class="docutils literal">ImportEngine</tt> but directly accessing the current global import
state. This can be easily implemented using class properties.</p>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id13">Specification</a></h1>
<div class="section" id="importengine-api">
<h2><a class="toc-backref" href="#id14">ImportEngine API</a></h2>
<p>The proposed extension consists of the following objects:</p>
<p><tt class="docutils literal">importlib.engine.ImportEngine</tt></p>
<blockquote>
<p><tt class="docutils literal">from_engine(self, other)</tt></p>
<blockquote>
Create a new import object from another ImportEngine instance. The
new object is initialised with a copy of the state in <tt class="docutils literal">other</tt>. When
called on <tt class="docutils literal">importlib engine.sysengine</tt>, <tt class="docutils literal">from_engine()</tt> can be
used to create an <tt class="docutils literal">ImportEngine</tt> object with a <strong>copy</strong> of the
global import state.</blockquote>
<p><tt class="docutils literal">__import__(self, name, <span class="pre">globals={},</span> <span class="pre">locals={},</span> <span class="pre">fromlist=[],</span> level=0)</tt></p>
<blockquote>
Reimplementation of the builtin <tt class="docutils literal">__import__()</tt> function. The
import of a module will proceed using the state stored in the
ImportEngine instance rather than the global import state. For full
documentation of <tt class="docutils literal">__import__</tt> functionality, see <a class="footnote-reference" href="#id6" id="id2">[2]</a> .
<tt class="docutils literal">__import__()</tt> from <tt class="docutils literal">ImportEngine</tt> and its subclasses can be used
to customise the behaviour of the <tt class="docutils literal">import</tt> statement by replacing
<tt class="docutils literal">__builtin__.__import__</tt> with <tt class="docutils literal"><span class="pre">ImportEngine().__import__</span></tt>.</blockquote>
<p><tt class="docutils literal">import_module(name, package=None)</tt></p>
<blockquote>
A reimplementation of <tt class="docutils literal">importlib.import_module()</tt> which uses the
import state stored in the ImportEngine instance. See <a class="footnote-reference" href="#id7" id="id3">[3]</a> for a full
reference.</blockquote>
<p><tt class="docutils literal">modules, path, path_hooks, meta_path, path_importer_cache</tt></p>
<blockquote>
Instance-specific versions of their process global <tt class="docutils literal">sys</tt> equivalents</blockquote>
</blockquote>
<p><tt class="docutils literal">importlib.engine.GlobalImportEngine(ImportEngine)</tt></p>
<blockquote>
Convenience class to provide engine-like access to the global state.
Provides <tt class="docutils literal">__import__()</tt>, <tt class="docutils literal">import_module()</tt> and <tt class="docutils literal">from_engine()</tt>
methods like <tt class="docutils literal">ImportEngine</tt> but writes through to the global state
in <tt class="docutils literal">sys</tt>.</blockquote>
<p>To support various namespace package mechanisms, when <tt class="docutils literal">sys.path</tt> is altered,
tools like <tt class="docutils literal">pkgutil.extend_path</tt> should be used to also modify other parts
of the import state (in this case, package <tt class="docutils literal">__path__</tt> attributes). The path
importer cache should also be invalidated when a variety of changes are made.</p>
<p>The <tt class="docutils literal">ImportEngine</tt> API will provide convenience methods that automatically
make related import state updates as part of a single operation.</p>
</div>
<div class="section" id="global-variables">
<h2><a class="toc-backref" href="#id15">Global variables</a></h2>
<p><tt class="docutils literal">importlib.engine.sysengine</tt></p>
<blockquote>
A precreated instance of <tt class="docutils literal">GlobalImportEngine</tt>. Intended for use by
importers and loaders that have been updated to accept optional <tt class="docutils literal">engine</tt>
parameters and with <tt class="docutils literal">ImportEngine.from_engine(sysengine)</tt> to start with
a copy of the process global import state.</blockquote>
</div>
<div class="section" id="no-changes-to-finder-loader-interfaces">
<h2><a class="toc-backref" href="#id16">No changes to finder/loader interfaces</a></h2>
<p>Rather than attempting to update the <a class="reference external" href="/dev/peps/pep-0302">PEP 302</a> APIs to accept additional state,
this PEP proposes that <tt class="docutils literal">ImportEngine</tt> support the content management
protocol (similar to the context substitution mechanisms in the <tt class="docutils literal">decimal</tt>
module).</p>
<p>The context management mechanism for <tt class="docutils literal">ImportEngine</tt> would:</p>
<ul class="simple">
<li>On entry:
* Acquire the import lock
* Substitute the global import state with the import engine's own state</li>
<li>On exit:
* Restore the previous global import state
* Release the import lock</li>
</ul>
<p>The precise API for this is TBD (but will probably use a distinct context
management object, along the lines of that created by
<tt class="docutils literal">decimal.localcontext</tt>).</p>
</div>
</div>
<div class="section" id="open-issues">
<h1><a class="toc-backref" href="#id17">Open Issues</a></h1>
<div class="section" id="api-design-for-falling-back-to-global-import-state">
<h2><a class="toc-backref" href="#id18">API design for falling back to global import state</a></h2>
<p>The current proposal relies on the <tt class="docutils literal">from_engine()</tt> API to fall back to the
global import state. It may be desirable to offer a variant that instead falls
back to the global import state dynamically.</p>
<p>However, one big advantage of starting with an &quot;as isolated as possible&quot;
design is that it becomes possible to experiment with subclasses that blur
the boundaries between the engine instance state and the process global state
in various ways.</p>
</div>
<div class="section" id="builtin-and-extension-modules-must-be-process-global">
<h2><a class="toc-backref" href="#id19">Builtin and extension modules must be process global</a></h2>
<p>Due to platform limitations, only one copy of each builtin and extension
module can readily exist in each process. Accordingly, it is impossible for
each <tt class="docutils literal">ImportEngine</tt> instance to load such modules independently.</p>
<p>The simplest solution is for <tt class="docutils literal">ImportEngine</tt> to refuse to load such modules,
raising <tt class="docutils literal">ImportError</tt>. <tt class="docutils literal">GlobalImportEngine</tt> would be able to load them
normally.</p>
<p><tt class="docutils literal">ImportEngine</tt> will still return such modules from a prepopulated module
cache - it's only loading them directly which causes problems.</p>
</div>
<div class="section" id="scope-of-substitution">
<h2><a class="toc-backref" href="#id20">Scope of substitution</a></h2>
<p>Related to the previous open issue is the question of what state to substitute
when using the context management API. It is currently the case that replacing
<tt class="docutils literal">sys.modules</tt> can be unreliable due to cached references and there's the
underlying fact that having independent copies of some modules is simply
impossible due to platform limitations.</p>
<p>As part of this PEP, it will be necessary to document explicitly:</p>
<ul class="simple">
<li>Which parts of the global import state can be substituted (and declare code
which caches references to that state without dealing with the substitution
case buggy)</li>
<li>Which parts must be modified in-place (and hence are not substituted by the
<tt class="docutils literal">ImportEngine</tt> context management API, or otherwise scoped to
<tt class="docutils literal">ImportEngine</tt> instances)</li>
</ul>
</div>
</div>
<div class="section" id="reference-implementation">
<h1><a class="toc-backref" href="#id21">Reference Implementation</a></h1>
<p>A reference implementation <a class="footnote-reference" href="#id8" id="id4">[4]</a> for an earlier draft of this PEP, based on
Brett Cannon's importlib has been developed by Greg Slodkowicz as part of the
2011 Google Summer of Code. Note that the current implementation avoids
modifying existing code, and hence duplicates a lot of things unnecessarily.
An actual implementation would just modify any such affected code in place.</p>
<p>That earlier draft of the PEP proposed change the <a class="reference external" href="/dev/peps/pep-0302">PEP 302</a> APIs to support passing
in an optional engine instance. This had the (serious) downside of not correctly
affecting further imports from the imported module, hence the change to the
context management based proposal for substituting the global state.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id22">References</a></h1>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><a class="reference external" href="/dev/peps/pep-0302">PEP 302</a>, New Import Hooks, J van Rossum, Moore
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0302">http://www.python.org/dev/peps/pep-0302</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>__import__() builtin function, The Python Standard Library documentation
(<a class="reference external" href="http://docs.python.org/library/functions.html#__import__">http://docs.python.org/library/functions.html#__import__</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id3">2</a>)</em> Importlib documentation, Cannon
(<a class="reference external" href="http://docs.python.org/dev/library/importlib">http://docs.python.org/dev/library/importlib</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>Reference implentation
(<a class="reference external" href="https://bitbucket.org/jergosh/gsoc_import_engine/src/default/Lib/importlib/engine.py">https://bitbucket.org/jergosh/gsoc_import_engine/src/default/Lib/importlib/engine.py</a>)</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id23">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>


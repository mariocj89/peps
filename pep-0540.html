<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">540</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Add a new UTF-8 Mode</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0540.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Victor Stinner &lt;victor.stinner&#32;&#97;t&#32;gmail.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">BDFL-Delegate:</th><td class="field-body">INADA Naoki</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">5-January-2016</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.7</td>
</tr>
<tr class="field"><th class="field-name">Resolution:</th><td class="field-body"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151173.html">https://mail.python.org/pipermail/python-dev/2017-December/151173.html</a></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id2">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id3">Rationale</a><ul>
<li><a class="reference internal" href="#locale-encoding-and-utf-8" id="id4">Locale encoding and UTF-8</a></li>
<li><a class="reference internal" href="#passthough-for-undecodable-bytes-surrogateescape" id="id5">Passthough for undecodable bytes: surrogateescape</a></li>
<li><a class="reference internal" href="#no-change-by-default-for-best-backward-compatibility" id="id6">No change by default for best backward compatibility</a></li>
</ul>
</li>
<li><a class="reference internal" href="#proposal" id="id7">Proposal</a></li>
<li><a class="reference internal" href="#relationship-with-the-locale-coercion-pep-538" id="id8">Relationship with the locale coercion (PEP 538)</a></li>
<li><a class="reference internal" href="#backward-compatibility" id="id9">Backward Compatibility</a></li>
<li><a class="reference internal" href="#annex-encodings-and-error-handlers" id="id10">Annex: Encodings And Error Handlers</a><ul>
<li><a class="reference internal" href="#encoding-and-error-handler" id="id11">Encoding and error handler</a></li>
<li><a class="reference internal" href="#encoding-and-error-handler-on-windows" id="id12">Encoding and error handler on Windows</a></li>
</ul>
</li>
<li><a class="reference internal" href="#links" id="id13">Links</a></li>
<li><a class="reference internal" href="#post-history" id="id14">Post History</a></li>
<li><a class="reference internal" href="#version-history" id="id15">Version History</a></li>
<li><a class="reference internal" href="#copyright" id="id16">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id2">Abstract</a></h1>
<p>Add a new &quot;UTF-8 Mode&quot; to enhance Python's use of UTF-8.  When UTF-8 Mode
is active, Python will:</p>
<ul class="simple">
<li>use the <tt class="docutils literal"><span class="pre">utf-8</span></tt> locale, irregardless of the locale currently set by
the current platform, and</li>
<li>change the <tt class="docutils literal">stdin</tt> and <tt class="docutils literal">stdout</tt> error handlers to
<tt class="docutils literal">surrogateescape</tt>.</li>
</ul>
<p>This mode is off by default, but is automatically activated when using
the &quot;POSIX&quot; locale.</p>
<p>Add the <tt class="docutils literal"><span class="pre">-X</span> utf8</tt> command line option and <tt class="docutils literal">PYTHONUTF8</tt> environment
variable to control UTF-8 Mode.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id3">Rationale</a></h1>
<div class="section" id="locale-encoding-and-utf-8">
<h2><a class="toc-backref" href="#id4">Locale encoding and UTF-8</a></h2>
<p>Python 3.6 uses the locale encoding for filenames, environment
variables, standard streams, etc. The locale encoding is inherited from
the locale; the encoding and the locale are tightly coupled.</p>
<p>Many users inherit the ASCII encoding from the POSIX locale, aka the &quot;C&quot;
locale, but are unable change the locale for various reasons.  This
encoding is very limited in term of Unicode support: any non-ASCII
character is likely to cause trouble.</p>
<p>It isn't always easy to get an accurate locale.  Locales don't get the
exact same name on different Linux distributions, FreeBSD, macOS, etc.
And some locales, like the recent <tt class="docutils literal"><span class="pre">C.UTF-8</span></tt> locale, are only supported
by a few platforms.  The current locale can even vary on the <em>same</em>
platform depending on context; for example, a SSH connection can use a
different encoding than the filesystem or local terminal encoding on the
same machine.</p>
<p>On the flip side, Python 3.6 is already using UTF-8 by default on macOS,
Android and Windows (<a class="reference external" href="/dev/peps/pep-0529">PEP 529</a>) for most functions -- although
<tt class="docutils literal">open()</tt> is a notable exception here. UTF-8 is also the default
encoding of Python scripts, XML and JSON file formats. The Go
programming language
uses UTF-8 for all strings.</p>
<p>UTF-8 support is nearly ubiquitous for data read and written by modern
platforms.  It also has excellent support in Python.  The problem is
simply that the locale is frequently misconfigured.  An obvious solution
suggests itself: ignore the locale encoding and use UTF-8.</p>
</div>
<div class="section" id="passthough-for-undecodable-bytes-surrogateescape">
<h2><a class="toc-backref" href="#id5">Passthough for undecodable bytes: surrogateescape</a></h2>
<p>When decoding bytes from UTF-8 using the default <tt class="docutils literal">strict</tt> error
handler, Python 3 raises a <tt class="docutils literal">UnicodeDecodeError</tt> on the first
undecodable byte.</p>
<p>Unix command line tools like <tt class="docutils literal">cat</tt> or <tt class="docutils literal">grep</tt> and most Python 2
applications simply do not have this class of bugs: they don't decode
data, but process data as a raw bytes sequence.</p>
<p>Python 3 already has a solution to behave like Unix tools and Python 2:
the <tt class="docutils literal">surrogateescape</tt> error handler (<a class="reference external" href="/dev/peps/pep-0383">PEP 383</a>). It allows processing
data as if it were bytes, but uses Unicode in practice; undecodable
bytes are stored as surrogate characters.</p>
<p>UTF-8 Mode sets the <tt class="docutils literal">surrogateescape</tt> error handler for <tt class="docutils literal">stdin</tt>
and <tt class="docutils literal">stdout</tt>, since these streams as commonly associated to Unix
command line tools.</p>
<p>However, users have a different expectation on files. Files are expected
to be properly encoded, and Python is expected to fail early when
<tt class="docutils literal">open()</tt> is called with the wrong options, like opening a JPEG picture
in text mode. The <tt class="docutils literal">open()</tt> default error handler remains <tt class="docutils literal">strict</tt>
for these reasons.</p>
</div>
<div class="section" id="no-change-by-default-for-best-backward-compatibility">
<h2><a class="toc-backref" href="#id6">No change by default for best backward compatibility</a></h2>
<p>While UTF-8 is perfect in most cases, sometimes the locale encoding is
actually the best encoding.</p>
<p>This PEP changes the behaviour for the POSIX locale since this locale is
usually equivalent to the ASCII encoding, whereas UTF-8 is a much better
choice. It does not change the behaviour for other locales to prevent
any risk or regression.</p>
<p>As users are responsible to enable explicitly the new UTF-8 Mode for
these other locales, they are responsible for any potential mojibake
issues caused by UTF-8 Mode.</p>
</div>
</div>
<div class="section" id="proposal">
<h1><a class="toc-backref" href="#id7">Proposal</a></h1>
<p>Add a new UTF-8 Mode to use the UTF-8 encoding, ignore the locale
encoding, and change <tt class="docutils literal">stdin</tt> and <tt class="docutils literal">stdout</tt> error handlers to
<tt class="docutils literal">surrogateescape</tt>.</p>
<p>Add the new <tt class="docutils literal"><span class="pre">-X</span> utf8</tt> command line option and <tt class="docutils literal">PYTHONUTF8</tt>
environment variable.  Users can explicitly activate UTF-8 Mode with the
command-line option <tt class="docutils literal"><span class="pre">-X</span> utf8</tt> or by setting the environment variable
<tt class="docutils literal">PYTHONUTF8=1</tt>.</p>
<p>This mode is disabled by default and enabled by the POSIX locale.  Users
can explicitly disable UTF-8 Mode with the command-line option <tt class="docutils literal"><span class="pre">-X</span>
utf8=0</tt> or by setting the environment variable <tt class="docutils literal">PYTHONUTF8=0</tt>.</p>
<p>For standard streams, the <tt class="docutils literal">PYTHONIOENCODING</tt> environment variable has
priority over UTF-8 Mode.</p>
<p>On Windows, the <tt class="docutils literal">PYTHONLEGACYWINDOWSFSENCODING</tt> environment variable
(<a class="reference external" href="/dev/peps/pep-0529">PEP 529</a>) has the priority over UTF-8 Mode.</p>
<p>Effects of UTF-8 Mode:</p>
<ul class="simple">
<li><tt class="docutils literal">sys.getfilesystemencoding()</tt> returns <tt class="docutils literal"><span class="pre">'UTF-8'</span></tt>.</li>
<li><tt class="docutils literal">locale.getpreferredencoding()</tt> returns <tt class="docutils literal"><span class="pre">UTF-8</span></tt>; its
<em>do_setlocale</em> argument, and the locale encoding, are ignored.</li>
<li><tt class="docutils literal">sys.stdin</tt> and <tt class="docutils literal">sys.stdout</tt> error handler is set to
<tt class="docutils literal">surrogateescape</tt>.</li>
</ul>
<p>Side effects:</p>
<ul class="simple">
<li><tt class="docutils literal">open()</tt> uses the UTF-8 encoding by default.  However, it still
uses the <tt class="docutils literal">strict</tt> error handler by default.</li>
<li><tt class="docutils literal">os.fsdecode()</tt> and <tt class="docutils literal">os.fsencode()</tt> use the UTF-8 encoding.</li>
<li>Command line arguments, environment variables and filenames use the
UTF-8 encoding.</li>
</ul>
</div>
<div class="section" id="relationship-with-the-locale-coercion-pep-538">
<h1>Relationship with the locale coercion (<a class="reference external" href="/dev/peps/pep-0538">PEP 538</a>)</h1>
<p>The POSIX locale enables the locale coercion (<a class="reference external" href="/dev/peps/pep-0538">PEP 538</a>) and the UTF-8
mode (<a class="reference external" href="/dev/peps/pep-0540">PEP 540</a>). When the locale coercion is enabled, enabling the
UTF-8 mode has no additional effect.</p>
<p>The UTF-8 Mode has the same effect as locale coercion:</p>
<ul class="simple">
<li><tt class="docutils literal">sys.getfilesystemencoding()</tt> returns <tt class="docutils literal"><span class="pre">'UTF-8'</span></tt>,</li>
<li><tt class="docutils literal">locale.getpreferredencoding()</tt> returns <tt class="docutils literal"><span class="pre">UTF-8</span></tt>, and</li>
<li>the <tt class="docutils literal">sys.stdin</tt> and <tt class="docutils literal">sys.stdout</tt> error handlers are set to
<tt class="docutils literal">surrogateescape</tt>.</li>
</ul>
<p>These changes only affect Python code. But the locale coercion has
addiditonal effects: the <tt class="docutils literal">LC_CTYPE</tt> environment variable and the
<tt class="docutils literal">LC_CTYPE</tt> locale are set to a UTF-8 locale like <tt class="docutils literal"><span class="pre">C.UTF-8</span></tt>. One side
effect is that non-Python code is also impacted by the locale coercion.
The two PEPs are complementary.</p>
<p>On platforms like Centos 7 where locale coercion is not supported, the
POSIX locale only enables UTF-8 Mode.  In this case, Python code uses
the UTF-8 encoding and ignores the locale encoding, whereas non-Python
code uses the locale encoding, which is usually ASCII for the POSIX
locale.</p>
<p>While the UTF-8 Mode is supported on all platforms and can be enabled
with any locale, the locale coercion is not supported by all platforms
and is restricted to the POSIX locale.</p>
<p>The UTF-8 Mode has only an impact on Python child processes when the
<tt class="docutils literal">PYTHONUTF8</tt> environment variable is set to <tt class="docutils literal">1</tt>, whereas the locale
coercion sets the <tt class="docutils literal">LC_CTYPE</tt> environment variables which impacts all
child processes.</p>
<p>The benefit of the locale coercion approach is that it helps ensure that
encoding handling in binary extension modules and child processes is
consistent with Python's encoding handling. The upside of the UTF-8 Mode
approach is that it allows an embedding application to change the
interpreter's behaviour without having to change the process global
locale settings.</p>
</div>
<div class="section" id="backward-compatibility">
<h1><a class="toc-backref" href="#id9">Backward Compatibility</a></h1>
<p>The only backward incompatible change is that the POSIX locale now
enables the UTF-8 Mode by default: it will now use the UTF-8 encoding,
ignore the locale encoding, and change <tt class="docutils literal">stdin</tt> and <tt class="docutils literal">stdout</tt> error
handlers to <tt class="docutils literal">surrogateescape</tt>.</p>
</div>
<div class="section" id="annex-encodings-and-error-handlers">
<h1><a class="toc-backref" href="#id10">Annex: Encodings And Error Handlers</a></h1>
<p>UTF-8 Mode changes the default encoding and error handler used by
<tt class="docutils literal">open()</tt>, <tt class="docutils literal">os.fsdecode()</tt>, <tt class="docutils literal">os.fsencode()</tt>, <tt class="docutils literal">sys.stdin</tt>,
<tt class="docutils literal">sys.stdout</tt> and <tt class="docutils literal">sys.stderr</tt>.</p>
<div class="section" id="encoding-and-error-handler">
<h2><a class="toc-backref" href="#id11">Encoding and error handler</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="30%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Default</th>
<th class="head">UTF-8 Mode or POSIX locale</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>open()</td>
<td>locale/strict</td>
<td><strong>UTF-8</strong>/strict</td>
</tr>
<tr><td>os.fsdecode(), os.fsencode()</td>
<td>locale/surrogateescape</td>
<td><strong>UTF-8</strong>/surrogateescape</td>
</tr>
<tr><td>sys.stdin, sys.stdout</td>
<td>locale/strict</td>
<td><strong>UTF-8/surrogateescape</strong></td>
</tr>
<tr><td>sys.stderr</td>
<td>locale/backslashreplace</td>
<td><strong>UTF-8</strong>/backslashreplace</td>
</tr>
</tbody>
</table>
<p>By comparison, Python 3.6 uses:</p>
<table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="30%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Default</th>
<th class="head">POSIX locale</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>open()</td>
<td>locale/strict</td>
<td>locale/strict</td>
</tr>
<tr><td>os.fsdecode(), os.fsencode()</td>
<td>locale/surrogateescape</td>
<td>locale/surrogateescape</td>
</tr>
<tr><td>sys.stdin, sys.stdout</td>
<td>locale/strict</td>
<td>locale/<strong>surrogateescape</strong></td>
</tr>
<tr><td>sys.stderr</td>
<td>locale/backslashreplace</td>
<td>locale/backslashreplace</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="encoding-and-error-handler-on-windows">
<h2><a class="toc-backref" href="#id12">Encoding and error handler on Windows</a></h2>
<p>On Windows, the encodings and error handlers are different:</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="22%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Default</th>
<th class="head">Legacy Windows FS encoding</th>
<th class="head">UTF-8 Mode</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>open()</td>
<td>mbcs/strict</td>
<td>mbcs/strict</td>
<td><strong>UTF-8</strong>/strict</td>
</tr>
<tr><td>os.fsdecode(), os.fsencode()</td>
<td>UTF-8/surrogatepass</td>
<td><strong>mbcs/replace</strong></td>
<td>UTF-8/surrogatepass</td>
</tr>
<tr><td>sys.stdin, sys.stdout</td>
<td>UTF-8/surrogateescape</td>
<td>UTF-8/surrogateescape</td>
<td>UTF-8/surrogateescape</td>
</tr>
<tr><td>sys.stderr</td>
<td>UTF-8/backslashreplace</td>
<td>UTF-8/backslashreplace</td>
<td>UTF-8/backslashreplace</td>
</tr>
</tbody>
</table>
<p>By comparison, Python 3.6 uses:</p>
<table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="30%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Function</th>
<th class="head">Default</th>
<th class="head">Legacy Windows FS encoding</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>open()</td>
<td>mbcs/strict</td>
<td>mbcs/strict</td>
</tr>
<tr><td>os.fsdecode(), os.fsencode()</td>
<td>UTF-8/surrogatepass</td>
<td><strong>mbcs/replace</strong></td>
</tr>
<tr><td>sys.stdin, sys.stdout</td>
<td>UTF-8/surrogateescape</td>
<td>UTF-8/surrogateescape</td>
</tr>
<tr><td>sys.stderr</td>
<td>UTF-8/backslashreplace</td>
<td>UTF-8/backslashreplace</td>
</tr>
</tbody>
</table>
<p>The &quot;Legacy Windows FS encoding&quot; is enabled by the
<tt class="docutils literal">PYTHONLEGACYWINDOWSFSENCODING</tt> environment variable.</p>
<p>If stdin and/or stdout is redirected to a pipe, <tt class="docutils literal">sys.stdin</tt> and/or
<tt class="docutils literal">sys.output</tt> uses <tt class="docutils literal">mbcs</tt> encoding by default rather than UTF-8.
But in UTF-8 Mode, <tt class="docutils literal">sys.stdin</tt> and <tt class="docutils literal">sys.stdout</tt> always use the UTF-8
encoding.</p>
<!-- note:
There is no POSIX locale on Windows. The ANSI code page is used as
the locale encoding, and this code page never uses the ASCII
encoding. -->
</div>
</div>
<div class="section" id="links">
<h1><a class="toc-backref" href="#id13">Links</a></h1>
<ul class="simple">
<li><a class="reference external" href="http://bugs.python.org/issue29240">bpo-29240: Implementation of the PEP 540: Add a new UTF-8 Mode</a></li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0538/">PEP 538</a>:
&quot;Coercing the legacy C locale to C.UTF-8&quot;</li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0529/">PEP 529</a>:
&quot;Change Windows filesystem encoding to UTF-8&quot;</li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0528/">PEP 528</a>:
&quot;Change Windows console encoding to UTF-8&quot;</li>
<li><a class="reference external" href="https://www.python.org/dev/peps/pep-0383/">PEP 383</a>:
&quot;Non-decodable Bytes in System Character Interfaces&quot;</li>
</ul>
</div>
<div class="section" id="post-history">
<h1><a class="toc-backref" href="#id14">Post History</a></h1>
<ul class="simple">
<li>2017-12: <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151054.html">[Python-Dev] PEP 540: Add a new UTF-8 Mode</a></li>
<li>2017-04: <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-April/147795.html">[Python-Dev] Proposed BDFL Delegate update for PEPs 538 &amp;
540 (assuming UTF-8 for *nix system boundaries)</a></li>
<li>2017-01: <a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2017-January/044089.html">[Python-ideas] PEP 540: Add a new UTF-8 Mode</a></li>
<li>2017-01: <a class="reference external" href="https://bugs.python.org/issue28180#msg284764">bpo-28180: Implementation of the PEP 538: coerce C locale to
C.utf-8 (msg284764)</a></li>
<li>2016-08-17: <a class="reference external" href="https://bugs.python.org/issue27781#msg272916">bpo-27781: Change sys.getfilesystemencoding() on Windows
to UTF-8 (msg272916)</a>
-- Victor proposed <tt class="docutils literal"><span class="pre">-X</span> utf8</tt> for the <a class="reference external" href="/dev/peps/pep-0529">PEP 529</a> (Change Windows
filesystem encoding to UTF-8)</li>
</ul>
</div>
<div class="section" id="version-history">
<h1><a class="toc-backref" href="#id15">Version History</a></h1>
<ul class="simple">
<li>Version 4: <tt class="docutils literal">locale.getpreferredencoding()</tt> now returns <tt class="docutils literal"><span class="pre">'UTF-8'</span></tt>
in the UTF-8 Mode.</li>
<li>Version 3: The UTF-8 Mode does not change the <tt class="docutils literal">open()</tt> default error
handler (<tt class="docutils literal">strict</tt>) anymore, and the Strict UTF-8 Mode has been
removed.</li>
<li>Version 2: Rewrite the PEP from scratch to make it much shorter and
easier to understand.</li>
<li>Version 1: First version posted to python-dev.</li>
</ul>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id16">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
</div>


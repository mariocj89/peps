<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">565</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Show DeprecationWarning in __main__</td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Nick Coghlan &lt;ncoghlan&#32;&#97;t&#32;gmail.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">12-Nov-2017</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.7</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">12-Nov-2017, 25-Nov-2017</td>
</tr>
<tr class="field"><th class="field-name">Resolution:</th><td class="field-body"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151224.html">https://mail.python.org/pipermail/python-dev/2017-December/151224.html</a></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id10">Abstract</a></li>
<li><a class="reference internal" href="#specification" id="id11">Specification</a><ul>
<li><a class="reference internal" href="#new-default-warnings-filter-entry" id="id12">New default warnings filter entry</a></li>
<li><a class="reference internal" href="#additional-use-case-for-futurewarning" id="id13">Additional use case for <tt class="docutils literal">FutureWarning</tt></a></li>
<li><a class="reference internal" href="#recommended-filter-settings-for-test-runners" id="id14">Recommended filter settings for test runners</a></li>
<li><a class="reference internal" href="#recommended-filter-settings-for-interactive-shells" id="id15">Recommended filter settings for interactive shells</a></li>
<li><a class="reference internal" href="#other-documentation-updates" id="id16">Other documentation updates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reference-implementation" id="id17">Reference Implementation</a></li>
<li><a class="reference internal" href="#motivation" id="id18">Motivation</a></li>
<li><a class="reference internal" href="#limitations-on-pep-scope" id="id19">Limitations on PEP Scope</a></li>
<li><a class="reference internal" href="#references" id="id20">References</a></li>
<li><a class="reference internal" href="#copyright" id="id21">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id10">Abstract</a></h1>
<p>In Python 2.7 and Python 3.2, the default warning filters were updated to hide
DeprecationWarning by default, such that deprecation warnings in development
tools that were themselves written in Python (e.g. linters, static analysers,
test runners, code generators), as well as any other applications that merely
happened to be written in Python, wouldn't be visible to their users unless
those users explicitly opted in to seeing them.</p>
<p>However, this change has had the unfortunate side effect of making
DeprecationWarning markedly less effective at its primary intended purpose:
providing advance notice of breaking changes in APIs (whether in CPython, the
standard library, or in third party libraries) to users of those APIs.</p>
<p>To improve this situation, this PEP proposes a single adjustment to the
default warnings filter: displaying deprecation warnings attributed to the main
module by default.</p>
<p>This change will mean that code entered at the interactive prompt and code in
single file scripts will revert to reporting these warnings by default, while
they will continue to be silenced by default for packaged code distributed as
part of an importable module.</p>
<p>The PEP also proposes a number of small adjustments to the reference
interpreter and standard library documentation to help make the warnings
subsystem more approachable for new Python developers.</p>
<p>As part of the documentation updates, it will be made clearer that the
<tt class="docutils literal">unittest</tt> test runner displays all warnings by default when executing
test cases, and that other test runners are advised to follow that example.</p>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id11">Specification</a></h1>
<div class="section" id="new-default-warnings-filter-entry">
<h2><a class="toc-backref" href="#id12">New default warnings filter entry</a></h2>
<p>The current set of default warnings filters consists of:</p>
<pre class="literal-block">
ignore::DeprecationWarning
ignore::PendingDeprecationWarning
ignore::ImportWarning
ignore::BytesWarning
ignore::ResourceWarning
</pre>
<p>The default <tt class="docutils literal">unittest</tt> test runner then uses <tt class="docutils literal">warnings.catch_warnings()</tt>
<tt class="docutils literal"><span class="pre">warnings.simplefilter('default')</span></tt> to override the default filters while
running test cases.</p>
<p>The change proposed in this PEP is to update the default warning filter list
to be:</p>
<pre class="literal-block">
default::DeprecationWarning:__main__
ignore::DeprecationWarning
ignore::PendingDeprecationWarning
ignore::ImportWarning
ignore::BytesWarning
ignore::ResourceWarning
</pre>
<p>This means that in cases where the nominal location of the warning (as
determined by the <tt class="docutils literal">stacklevel</tt> parameter to <tt class="docutils literal">warnings.warn</tt>) is in the
<tt class="docutils literal">__main__</tt> module, the first occurrence of each DeprecationWarning will once
again be reported.</p>
<p>This change will lead to DeprecationWarning being displayed by default for:</p>
<ul class="simple">
<li>code executed directly at the interactive prompt</li>
<li>code executed directly as part of a single-file script</li>
</ul>
<p>While continuing to be hidden by default for:</p>
<ul class="simple">
<li>code imported from another module in a <tt class="docutils literal">zipapp</tt> archive's <tt class="docutils literal">__main__.py</tt>
file</li>
<li>code imported from another module in an executable package's <tt class="docutils literal">__main__</tt>
submodule</li>
<li>code imported from an executable script wrapper generated at installation time
based on a <tt class="docutils literal">console_scripts</tt> or <tt class="docutils literal">gui_scripts</tt> entry point definition</li>
</ul>
<p>This means that tool developers that create an installable or executable
artifact (such as a <tt class="docutils literal">zipapp</tt> archive) for distribution to their users
shouldn't see any change from the status quo, while users of more ad hoc
personal or locally distributed scripts are likely to start seeing relevant
deprecation warnings again (as they did in Python 2.6 and earlier).</p>
</div>
<div class="section" id="additional-use-case-for-futurewarning">
<h2><a class="toc-backref" href="#id13">Additional use case for <tt class="docutils literal">FutureWarning</tt></a></h2>
<p>The standard library documentation will be updated to explicitly recommend the
use of <tt class="docutils literal">FutureWarning</tt> (rather than <tt class="docutils literal">DeprecationWarning</tt>) for backwards
compatibility warnings that are intended to be seen by <em>users</em> of an
application. (This will be in addition to the existing use of <tt class="docutils literal">FutureWarning</tt>
to warn about constructs that will remain valid code in the future,
but will have different semantics).</p>
<p>This will give the following three distinct categories of backwards
compatibility warning, with three different intended audiences:</p>
<ul class="simple">
<li><tt class="docutils literal">PendingDeprecationWarning</tt>: hidden by default for all code.
The intended audience is Python developers that take an active interest in
ensuring the future compatibility of their software (e.g. professional
Python application developers with specific support obligations).</li>
<li><tt class="docutils literal">DeprecationWarning</tt>: reported by default for code that runs directly in
the <tt class="docutils literal">__main__</tt> module (as such code is considered relatively unlikely to
have a dedicated test suite), but hidden by default for code in other modules.
The intended audience is Python developers that are at risk of upgrades to
their dependencies (including upgrades to Python itself) breaking their
software (e.g. developers using Python to script environments where someone
else is in control of the timing of dependency upgrades).</li>
<li><tt class="docutils literal">FutureWarning</tt>: reported by default for all code.
The intended audience is users of applications written in Python, rather than
other Python developers (e.g. warning about use of a deprecated setting in a
configuration file format).</li>
</ul>
<p>For library and framework authors that want to ensure their API compatibility
warnings are more reliably seen by their users, the recommendation is to use a
custom warning class that derives from <tt class="docutils literal">DeprecationWarning</tt> in Python 3.7+,
and from <tt class="docutils literal">FutureWarning</tt> in earlier versions.</p>
</div>
<div class="section" id="recommended-filter-settings-for-test-runners">
<h2><a class="toc-backref" href="#id14">Recommended filter settings for test runners</a></h2>
<p>Developers of test runners are advised to implement logic equivalent to the
following when determining their default warnings filters:</p>
<pre class="literal-block">
if not sys.warnoptions:
    warnings.simplefilter(&quot;default&quot;)
</pre>
<p>This effectively enables all warnings by default, as if the <tt class="docutils literal"><span class="pre">-Wd</span></tt> command
line option had been passed.</p>
<p>Note that actually enabling <tt class="docutils literal">BytesWarning</tt> in a test suite still requires
passing the <tt class="docutils literal"><span class="pre">-b</span></tt> option to the interpreter at the command line. For implicit
bytes conversion and bytes comparison warnings, the warnings filter machinery
is only used to determine whether they should be printed as warnings or raised
as exceptions - when the command line flag isn't set, the interpreter doesn't
even emit the warning in the first place.</p>
</div>
<div class="section" id="recommended-filter-settings-for-interactive-shells">
<h2><a class="toc-backref" href="#id15">Recommended filter settings for interactive shells</a></h2>
<p>Developers of interactive shells are advised to add a filter that enables
<tt class="docutils literal">DeprecationWarning</tt> in the namespace where user code is entered and executed.</p>
<p>If that namespace is <tt class="docutils literal">__main__</tt> (as it is for the default CPython REPL), then
no changes are needed beyond those in this PEP.</p>
<p>Interactive shell implementations which use a namespace other than
<tt class="docutils literal">__main__</tt> will need to add their own filter. For example, IPython uses the
following command ([<a class="reference internal" href="#id8">8</a>]) to set up a suitable filter:</p>
<pre class="literal-block">
warnings.filterwarnings(&quot;default&quot;, category=DeprecationWarning,
                                   module=self.user_ns.get(&quot;__name__&quot;))
</pre>
</div>
<div class="section" id="other-documentation-updates">
<h2><a class="toc-backref" href="#id16">Other documentation updates</a></h2>
<p>The current reference documentation for the warnings system is relatively short
on specific <em>examples</em> of possible settings for the <tt class="docutils literal"><span class="pre">-W</span></tt> command line option
or the <tt class="docutils literal">PYTHONWARNINGS</tt> environment variably that achieve particular end
results.</p>
<p>The following improvements are proposed as part of the implementation of this
PEP:</p>
<ul>
<li><p class="first">Explicitly list the following entries under the description of the
<tt class="docutils literal">PYTHONWARNINGS</tt> environment variable:</p>
<pre class="literal-block">
PYTHONWARNINGS=error # Convert to exceptions
PYTHONWARNINGS=always # Warn every time
PYTHONWARNINGS=default # Warn once per call location
PYTHONWARNINGS=module # Warn once per calling module
PYTHONWARNINGS=once # Warn once per Python process
PYTHONWARNINGS=ignore # Never warn
</pre>
</li>
<li><p class="first">Explicitly list the corresponding short options
(<tt class="docutils literal"><span class="pre">-We</span></tt>, <tt class="docutils literal"><span class="pre">-Wa</span></tt>, <tt class="docutils literal"><span class="pre">-Wd</span></tt>, <tt class="docutils literal"><span class="pre">-Wm</span></tt>, <tt class="docutils literal"><span class="pre">-Wo</span></tt>, <tt class="docutils literal"><span class="pre">-Wi</span></tt>) for each of the
warning actions listed under the <tt class="docutils literal"><span class="pre">-W</span></tt> command line switch documentation</p>
</li>
<li><p class="first">Explicitly list the default filter set in the <tt class="docutils literal">warnings</tt> module
documentation, using the <tt class="docutils literal"><span class="pre">action::category</span></tt> and <tt class="docutils literal"><span class="pre">action::category:module</span></tt>
notation</p>
</li>
<li><p class="first">Explicitly list the following snippet in the <tt class="docutils literal">warnings.simplefilter</tt>
documentation as a recommended approach to turning off all warnings by
default in a Python application while still allowing them to be turned
back on via <tt class="docutils literal">PYTHONWARNINGS</tt> or the <tt class="docutils literal"><span class="pre">-W</span></tt> command line switch:</p>
<pre class="literal-block">
if not sys.warnoptions:
    warnings.simplefilter(&quot;ignore&quot;)
</pre>
</li>
</ul>
<p>None of these are <em>new</em> (they already work in all still supported Python
versions), but they're not especially obvious given the current structure
of the related documentation.</p>
</div>
</div>
<div class="section" id="reference-implementation">
<h1><a class="toc-backref" href="#id17">Reference Implementation</a></h1>
<p>A reference implementation is available in the PR [<a class="reference internal" href="#id4">4</a>] linked from the
related tracker issue for this PEP [<a class="reference internal" href="#id5">5</a>].</p>
<p>As a side-effect of implementing this PEP, the internal warnings filter list
will start allowing the use of plain strings as part of filter definitions (in
addition to the existing use of compiled regular expressions). When present,
the plain strings will be compared for exact matches only. This approach allows
the new default filter to be added during interpreter startup without requiring
early access to the <tt class="docutils literal">re</tt> module.</p>
</div>
<div class="section" id="motivation">
<h1><a class="toc-backref" href="#id18">Motivation</a></h1>
<p>As discussed in [<a class="reference internal" href="#id1">1</a>] and mentioned in [<a class="reference internal" href="#id2">2</a>], Python 2.7 and Python 3.2 changed
the default handling of <tt class="docutils literal">DeprecationWarning</tt> such that:</p>
<ul class="simple">
<li>the warning was hidden by default during normal code execution</li>
<li>the <tt class="docutils literal">unittest</tt> test runner was updated to re-enable it when running tests</li>
</ul>
<p>The intent was to avoid cases of tooling output like the following:</p>
<pre class="literal-block">
$ devtool mycode/
/usr/lib/python3.6/site-packages/devtool/cli.py:1: DeprecationWarning: 'async' and 'await' will become reserved keywords in Python 3.7
  async = True
... actual tool output ...
</pre>
<p>Even when <cite>devtool</cite> is a tool specifically for Python programmers, this is not
a particularly useful warning, as it will be shown on every invocation, even
though the main helpful step an end user can take is to report a bug to the
developers of <tt class="docutils literal">devtool</tt>.</p>
<p>The warning is even less helpful for general purpose developer tools that are
used across more languages than just Python, and almost entirely *un*helpful
for applications that simply happen to be written in Python, and aren't
necessarily intended for a developer audience at all.</p>
<p>However, this change proved to have unintended consequences for the following
audiences:</p>
<ul class="simple">
<li>anyone using a test runner other than the default one built into <tt class="docutils literal">unittest</tt>
(the request for third party test runners to change their default warnings
filters was never made explicitly, so many of them still rely on the
interpreter defaults that are designed to suit deployed applications)</li>
<li>anyone using the default <tt class="docutils literal">unittest</tt> test runner to test their Python code
in a subprocess (since even <tt class="docutils literal">unittest</tt> only adjusts the warnings settings
in the current process)</li>
<li>anyone writing Python code at the interactive prompt or as part of a directly
executed script that didn't have a Python level test suite at all</li>
</ul>
<p>In these cases, <tt class="docutils literal">DeprecationWarning</tt> ended up become almost entirely
equivalent to <tt class="docutils literal">PendingDeprecationWarning</tt>: it was simply never seen at all.</p>
</div>
<div class="section" id="limitations-on-pep-scope">
<h1><a class="toc-backref" href="#id19">Limitations on PEP Scope</a></h1>
<p>This PEP exists specifically to explain both the proposed addition to the
default warnings filter for 3.7, <em>and</em> to more clearly articulate the rationale
for the original change to the handling of DeprecationWarning back in Python 2.7
and 3.2.</p>
<p>This PEP does not solve all known problems with the current approach to handling
deprecation warnings. Most notably:</p>
<ul class="simple">
<li>The default <tt class="docutils literal">unittest</tt> test runner does not currently report deprecation
warnings emitted at module import time, as the warnings filter override is only
put in place during test execution, not during test discovery and loading.</li>
<li>The default <tt class="docutils literal">unittest</tt> test runner does not currently report deprecation
warnings in subprocesses, as the warnings filter override is applied directly
to the loaded <tt class="docutils literal">warnings</tt> module, not to the <tt class="docutils literal">PYTHONWARNINGS</tt> environment
variable.</li>
<li>The standard library doesn't provide a straightforward way to opt-in to seeing
all warnings emitted <em>by</em> a particular dependency prior to upgrading it
(the third-party <tt class="docutils literal">warn</tt> module [<a class="reference internal" href="#id3">3</a>] does provide this, but enabling it
involves monkeypatching the standard library's <tt class="docutils literal">warnings</tt> module).</li>
<li>When software has been factored out into support modules, but those modules
have little or no automated test coverage, re-enabling deprecation warnings
by default in <tt class="docutils literal">__main__</tt> isn't likely to help find API compatibility
problems. Near term, the best currently available answer is to run affected
applications with <tt class="docutils literal"><span class="pre">PYTHONWARNINGS=default::DeprecationWarning</span></tt> or
<tt class="docutils literal">python <span class="pre">-W</span> <span class="pre">default::DeprecationWarning</span></tt> and pay attention to their
<tt class="docutils literal">stderr</tt> output. Longer term, this is really a question for researchers
working on static analysis of Python code: how to reliably find usage of
deprecated APIs, and how to infer that an API or parameter is deprecated
based on <tt class="docutils literal">warnings.warn</tt> calls, without actually running either the code
providing the API or the code accessing it.</li>
</ul>
<p>While these are real problems with the status quo, they're excluded from
consideration in this PEP because they're going to require more complex
solutions than a single additional entry in the default warnings filter,
and resolving them at least potentially won't require going through the PEP
process.</p>
<p>For anyone interested in pursuing them further, the first two would be
<tt class="docutils literal">unittest</tt> module enhancement requests, the third would be a <tt class="docutils literal">warnings</tt>
module enhancement request, while the last would only require a PEP if
inferring API deprecations from their contents was deemed to be an intractable
code analysis problem, and an explicit function and parameter marker syntax in
annotations was proposed instead.</p>
<p>The CPython reference implementation will also include the following related
changes in 3.7:</p>
<ul class="simple">
<li>a new <tt class="docutils literal"><span class="pre">-X</span> dev</tt> command line option that combines several developer centric
settings (including <tt class="docutils literal"><span class="pre">-Wd</span></tt>) into one command line flag:
<a class="reference external" href="https://bugs.python.org/issue32043">https://bugs.python.org/issue32043</a></li>
<li>changing the behaviour in debug builds to show more of the warnings that are
off by default in regular interpeter builds: <a class="reference external" href="https://bugs.python.org/issue32088">https://bugs.python.org/issue32088</a></li>
</ul>
<p>Independently of the proposed changes to the default filters in this PEP,
issue 32229 [<a class="reference internal" href="#id9">9</a>] is a proposal to add a <tt class="docutils literal">warnings.hide_warnings</tt> API to
make it simpler for application developers to hide warnings during normal
operation, while easily making them visible when testing.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id20">References</a></h1>
<table class="docutils footnote" frame="void" id="id1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td>stdlib-sig thread proposing the original default filter change
(<a class="reference external" href="https://mail.python.org/pipermail/stdlib-sig/2009-November/000789.html">https://mail.python.org/pipermail/stdlib-sig/2009-November/000789.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td>Python 2.7 notification of the default warnings filter change
(<a class="reference external" href="https://docs.python.org/3/whatsnew/2.7.html#changes-to-the-handling-of-deprecation-warnings">https://docs.python.org/3/whatsnew/2.7.html#changes-to-the-handling-of-deprecation-warnings</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td>Emitting warnings based on the location of the warning itself
(<a class="reference external" href="https://pypi.org/project/warn/">https://pypi.org/project/warn/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td>GitHub PR for <a class="reference external" href="/dev/peps/pep-0565">PEP 565</a> implementation
(<a class="reference external" href="https://github.com/python/cpython/pull/4458">https://github.com/python/cpython/pull/4458</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td>Tracker issue for <a class="reference external" href="/dev/peps/pep-0565">PEP 565</a> implementation
(<a class="reference external" href="https://bugs.python.org/issue31975">https://bugs.python.org/issue31975</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[6]</td><td>First python-dev discussion thread
(<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-November/150477.html">https://mail.python.org/pipermail/python-dev/2017-November/150477.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[7]</td><td>Second python-dev discussion thread
(<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-November/150819.html">https://mail.python.org/pipermail/python-dev/2017-November/150819.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[8]</td><td>IPython's DeprecationWarning auto-configuration
(<a class="reference external" href="https://github.com/ipython/ipython/blob/6.2.x/IPython/core/interactiveshell.py#L619">https://github.com/ipython/ipython/blob/6.2.x/IPython/core/interactiveshell.py#L619</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[9]</td><td><tt class="docutils literal">warnings.hide_warnings</tt> API proposal
(<a class="reference external" href="https://bugs.python.org/issue32229">https://bugs.python.org/issue32229</a>)</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id21">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>


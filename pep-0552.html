<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">552</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Deterministic pycs</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0552.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Benjamin Peterson &lt;benjamin&#32;&#97;t&#32;python.org&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">2017-09-04</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.7</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">2017-09-07</td>
</tr>
<tr class="field"><th class="field-name">Resolution:</th><td class="field-body"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-September/149649.html">https://mail.python.org/pipermail/python-dev/2017-September/149649.html</a></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id13">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id14">Rationale</a></li>
<li><a class="reference internal" href="#specification" id="id15">Specification</a></li>
<li><a class="reference internal" href="#references" id="id16">References</a></li>
<li><a class="reference internal" href="#credits" id="id17">Credits</a></li>
<li><a class="reference internal" href="#copyright" id="id18">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id13">Abstract</a></h1>
<p>This PEP proposes an extension to the pyc format to make it more deterministic.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id14">Rationale</a></h1>
<p>A <a class="reference external" href="https://reproducible-builds.org/">reproducible build</a> <a class="footnote-reference" href="#id3" id="id4">[3]</a> is one where the same byte-for-byte output is generated
every time the same sources are built—even across different machines (naturally
subject to the requirement that they have rather similar environments
setup). Reproducibility is important for security. It is also a key concept in
content-based build systems such as <a class="reference external" href="https://bazel.build/">Bazel</a> <a class="footnote-reference" href="#id5" id="id6">[4]</a>, which are most effective when the
output files’ contents are a deterministic function of the input files’
contents.</p>
<p>The current Python pyc format is the marshaled code object of the module
prefixed by a <a class="reference external" href="https://docs.python.org/3/library/importlib.html#importlib.util.MAGIC_NUMBER">magic number</a> <a class="footnote-reference" href="#id11" id="id12">[7]</a>, the source timestamp, and the source file
size. The presence of a source timestamp means that a pyc is not a deterministic
function of the input file’s contents—it also depends on volatile metadata, the
mtime of the source. Thus, pycs are a barrier to proper reproducibility.</p>
<p>Distributors of Python code are currently stuck with the options of</p>
<ol class="arabic simple">
<li>not distributing pycs and losing the caching advantages</li>
<li>distributing pycs and losing reproducibility</li>
<li>carefully giving all Python source files a deterministic timestamp
(see, for example, <a class="reference external" href="https://github.com/python/cpython/pull/296">https://github.com/python/cpython/pull/296</a>)</li>
<li>doing a complicated mixture of 1. and 2. like generating pycs at installation
time</li>
</ol>
<p>None of these options are very attractive. This PEP proposes allowing the
timestamp to be replaced with a deterministic hash. The current timestamp
invalidation method will remain the default, though. Despite its nondeterminism,
timestamp invalidation works well for many workflows and usecases. The
hash-based pyc format can impose the cost of reading and hashing every source
file, which is more expensive than simply checking timestamps. Thus, for now, we
expect it to be used mainly by distributors and power use cases.</p>
<p>(Note there are other problems <a class="footnote-reference" href="#frozensets" id="id1">[1]</a> <a class="footnote-reference" href="#interning" id="id2">[2]</a> we do not
address here that can make pycs non-deterministic.)</p>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id15">Specification</a></h1>
<p>The pyc header currently consists of 3 32-bit words. We will expand it to 4. The
first word will continue to be the magic number, versioning the bytecode and pyc
format. The second word, conceptually the new word, will be a bit field. The
interpretation of the rest of the header and invalidation behavior of the pyc
depends on the contents of the bit field.</p>
<p>If the bit field is 0, the pyc is a traditional timestamp-based pyc. I.e., the
third and forth words will be the timestamp and file size respectively, and
invalidation will be done by comparing the metadata of the source file with that
in the header.</p>
<p>If the lowest bit of the bit field is set, the pyc is a hash-based pyc. We call
the second lowest bit the <tt class="docutils literal">check_source</tt> flag. Following the bit field is a
64-bit hash of the source file. We will use a <a class="reference external" href="https://131002.net/siphash/">SipHash</a> <a class="footnote-reference" href="#id9" id="id10">[6]</a> with a hardcoded key of
the contents of the source file. Another fast hash like MD5 or <a class="reference external" href="https://blake2.net/">BLAKE2</a> <a class="footnote-reference" href="#id7" id="id8">[5]</a> would
also work. We choose SipHash because Python already has a builtin implementation
of it from <a class="reference external" href="/dev/peps/pep-0456">PEP 456</a>, although an interface that allows picking the SipHash key
must be exposed to Python. Security of the hash is not a concern, though we pass
over completely-broken hashes like MD5 to ease auditing of Python in controlled
environments.</p>
<p>When Python encounters a hash-based pyc, its behavior depends on the setting of
the <tt class="docutils literal">check_source</tt> flag. If the <tt class="docutils literal">check_source</tt> flag is set, Python will
determine the validity of the pyc by hashing the source file and comparing the
hash with the expected hash in the pyc. If the pyc needs to be regenerated, it
will be regenerated as a hash-based pyc again with the <tt class="docutils literal">check_source</tt> flag
set.</p>
<p>For hash-based pycs with the <tt class="docutils literal">check_source</tt> unset, Python will simply load the
pyc without checking the hash of the source file. The expectation in this case
is that some external system (e.g., the local Linux distribution’s package
manager) is responsible for keeping pycs up to date, so Python itself doesn’t
have to check. Even when validation is disabled, the hash field should be set
correctly, so out-of-band consistency checkers can verify the up-to-dateness of
the pyc. Note also that the <a class="reference external" href="/dev/peps/pep-3147">PEP 3147</a> edict that pycs without corresponding
source files not be loaded will still be enforced for hash-based pycs.</p>
<p>The programmatic APIs of <tt class="docutils literal">py_compile</tt> and <tt class="docutils literal">compileall</tt> will support
generation of hash-based pycs. Principally, <tt class="docutils literal">py_compile</tt> will define a new
enumeration corresponding to all the available pyc invalidation modules:</p>
<pre class="literal-block">
class PycInvalidationMode(Enum):
    TIMESTAMP
    CHECKED_HASH
    UNCHECKED_HASH
</pre>
<p><tt class="docutils literal">py_compile.compile</tt>, <tt class="docutils literal">compileall.compile_dir</tt>, and
<tt class="docutils literal">compileall.compile_file</tt> will all gain an <tt class="docutils literal">invalidation_mode</tt> parameter,
which accepts a value of the <tt class="docutils literal">PycInvalidationMode</tt> enumeration.</p>
<p>The <tt class="docutils literal">compileall</tt> tool will be extended with a command new option,
<tt class="docutils literal"><span class="pre">--invalidation-mode</span></tt> to generate hash-based pycs with and without the
<tt class="docutils literal">check_source</tt> bit set. <tt class="docutils literal"><span class="pre">--invalidation-mode</span></tt> will be a tristate option
taking values <tt class="docutils literal">timestamp</tt> (the default), <tt class="docutils literal"><span class="pre">checked-hash</span></tt>, and
<tt class="docutils literal"><span class="pre">unchecked-hash</span></tt> corresponding to the values of <tt class="docutils literal">PycInvalidationMode</tt>.</p>
<p><tt class="docutils literal">importlib.util</tt> will be extended with a <tt class="docutils literal">source_hash(source)</tt> function that
computes the hash used by the pyc writing code for a bytestring <strong>source</strong>.</p>
<p>Runtime configuration of hash-based pyc invalidation will be facilitated by a
new <tt class="docutils literal"><span class="pre">--check-hash-based-pycs</span></tt> interpreter option. This is a tristate option,
which may take 3 values: <tt class="docutils literal">default</tt>, <tt class="docutils literal">always</tt>, and <tt class="docutils literal">never</tt>. The default
value, <tt class="docutils literal">default</tt>, means the <tt class="docutils literal">check_source</tt> flag in hash-based pycs
determines invalidation as described above. <tt class="docutils literal">always</tt> causes the interpreter to
hash the source file for invalidation regardless of value of <tt class="docutils literal">check_source</tt>
bit. <tt class="docutils literal">never</tt> causes the interpreter to always assume hash-based pycs are
valid. When <tt class="docutils literal"><span class="pre">--check-hash-based-pycs=never</span></tt> is in effect, unchecked hash-based
pycs will be regenerated as unchecked hash-based pycs. Timestamp-based pycs are
unaffected by <tt class="docutils literal"><span class="pre">--check-hash-based-pycs</span></tt>.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id16">References</a></h1>
<table class="docutils footnote" frame="void" id="frozensets" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://benno.id.au/blog/2013/01/15/python-determinism">http://benno.id.au/blog/2013/01/15/python-determinism</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="interning" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://bugzilla.opensuse.org/show_bug.cgi?id=1049186">http://bugzilla.opensuse.org/show_bug.cgi?id=1049186</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td><a class="reference external" href="https://reproducible-builds.org/">https://reproducible-builds.org/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[4]</a></td><td><a class="reference external" href="https://bazel.build/">https://bazel.build/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[5]</a></td><td><a class="reference external" href="https://blake2.net/">https://blake2.net/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[6]</a></td><td><a class="reference external" href="https://131002.net/siphash/">https://131002.net/siphash/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id12">[7]</a></td><td><a class="reference external" href="https://docs.python.org/3/library/importlib.html#importlib.util.MAGIC_NUMBER">https://docs.python.org/3/library/importlib.html#importlib.util.MAGIC_NUMBER</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="credits">
<h1><a class="toc-backref" href="#id17">Credits</a></h1>
<p>The author would like to thank Gregory P. Smith, Christian Heimes, and Steve
Dower for useful conversations on the topic of this PEP.</p>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id18">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 80
coding: utf-8
End: -->
</div>


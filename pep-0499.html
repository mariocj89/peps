<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">499</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body"><tt class="docutils literal">python <span class="pre">-m</span> foo</tt> should bind <tt class="docutils literal"><span class="pre">sys.modules['foo']</span></tt> in addition to <tt class="docutils literal"><span class="pre">sys.modules['__main__']</span></tt></td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0499.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Cameron Simpson &lt;cs&#32;&#97;t&#32;zip.com.au&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">07-Aug-2015</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.6</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id8">Abstract</a></li>
<li><a class="reference internal" href="#proposal" id="id9">Proposal</a></li>
<li><a class="reference internal" href="#considerations-and-prerequisites" id="id10">Considerations and Prerequisites</a><ul>
<li><a class="reference internal" href="#pickling-modules" id="id11">Pickling Modules</a></li>
</ul>
</li>
<li><a class="reference internal" href="#background" id="id12">Background</a></li>
<li><a class="reference internal" href="#references" id="id13">References</a></li>
<li><a class="reference internal" href="#copyright" id="id14">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id8">Abstract</a></h1>
<p>When a module is used as a main program on the Python command line,
such as by:</p>
<blockquote>
python -m module.name ...</blockquote>
<p>it is easy to accidentally end up with two independent instances
of the module if that module is again imported within the program.
This PEP proposes a way to fix this problem.</p>
<p>When a module is invoked via Python's -m option the module is bound
to <tt class="docutils literal"><span class="pre">sys.modules['__main__']</span></tt> and its <tt class="docutils literal">.__name__</tt> attribute is set to
<tt class="docutils literal">'__main__'</tt>.
This enables the standard &quot;main program&quot; boilerplate code at the
bottom of many modules, such as:</p>
<pre class="literal-block">
if __name__ == '__main__':
    sys.exit(main(sys.argv))
</pre>
<p>However, when the above command line invocation is used it is a
natural inference to presume that the module is actually imported
under its official name <tt class="docutils literal">module.name</tt>,
and therefore that if the program again imports that name
then it will obtain the same module instance.</p>
<p>That actuality is that the module was imported only as <tt class="docutils literal">'__main__'</tt>.
Another import will obtain a distinct module instance, which can
lead to confusing bugs.</p>
</div>
<div class="section" id="proposal">
<h1><a class="toc-backref" href="#id9">Proposal</a></h1>
<p>It is suggested that to fix this situation all that is needed is a
simple change to the way the <tt class="docutils literal"><span class="pre">-m</span></tt> option is implemented: in addition
to binding the module object to <tt class="docutils literal"><span class="pre">sys.modules['__main__']</span></tt>, it is also
bound to <tt class="docutils literal"><span class="pre">sys.modules['module.name']</span></tt>.</p>
<p>Nick Coghlan has suggested that this is as simple as modifying the
<tt class="docutils literal">runpy</tt> module's <tt class="docutils literal">_run_module_as_main</tt> function as follows:</p>
<pre class="literal-block">
main_globals = sys.modules[&quot;__main__&quot;].__dict__
</pre>
<p>to instead be:</p>
<pre class="literal-block">
main_module = sys.modules[&quot;__main__&quot;]
sys.modules[mod_spec.name] = main_module
main_globals = main_module.__dict__
</pre>
</div>
<div class="section" id="considerations-and-prerequisites">
<h1><a class="toc-backref" href="#id10">Considerations and Prerequisites</a></h1>
<div class="section" id="pickling-modules">
<h2><a class="toc-backref" href="#id11">Pickling Modules</a></h2>
<p>Nick has mentioned <a class="reference external" href="http://bugs.python.org/issue19702">issue 19702</a> <a class="footnote-reference" href="#id1" id="id2">[1]</a> which proposes (quoted from the issue):</p>
<ul class="simple">
<li>runpy will ensure that when __main__ is executed via the import
system, it will also be aliased in sys.modules as __spec__.name</li>
<li>if __main__.__spec__ is set, pickle will use __spec__.name rather
than __name__ to pickle classes, functions and methods defined in
__main__</li>
<li>multiprocessing is updated appropriately to skip creating __mp_main__
in child processes when __main__.__spec__ is set in the parent
process</li>
</ul>
<p>The first point above covers this PEP's specific proposal.</p>
</div>
</div>
<div class="section" id="background">
<h1><a class="toc-backref" href="#id12">Background</a></h1>
<p><a class="reference external" href="https://mail.python.org/pipermail/python-list/2015-August/694905.html">I tripped over this issue</a> <a class="footnote-reference" href="#id4" id="id5">[2]</a> while debugging a main program via a
module which tried to monkey patch a named module, that being the
main program module.  Naturally, the monkey patching was ineffective
as it imported the main module by name and thus patched the second
module instance, not the running module instance.</p>
<p>However, the problem has been around as long as the <tt class="docutils literal"><span class="pre">-m</span></tt> command
line option and is encountered regularly, if infrequently, by others.</p>
<p>In addition to <a class="reference external" href="http://bugs.python.org/issue19702">issue 19702</a> <a class="footnote-reference" href="#id1" id="id3">[1]</a>, the discrepancy around <cite>__main__</cite>
is alluded to in <a class="reference external" href="/dev/peps/pep-0451">PEP 451</a> and a similar proposal (predating <a class="reference external" href="/dev/peps/pep-0451">PEP 451</a>)
is described in <a class="reference external" href="/dev/peps/pep-0395">PEP 395</a> under <a class="reference external" href="https://www.python.org/dev/peps/pep-0395/#fixing-dual-imports-of-the-main-module">Fixing dual imports of the main module</a> <a class="footnote-reference" href="#id6" id="id7">[3]</a>.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id13">References</a></h1>
<table class="docutils footnote" frame="void" id="id1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id2">1</a>, <a class="fn-backref" href="#id3">2</a>)</em> <a class="reference external" href="http://bugs.python.org/issue19702">http://bugs.python.org/issue19702</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[2]</a></td><td><a class="reference external" href="https://mail.python.org/pipermail/python-list/2015-August/694905.html">https://mail.python.org/pipermail/python-list/2015-August/694905.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td><a class="reference external" href="https://www.python.org/dev/peps/pep-0395/#fixing-dual-imports-of-the-main-module">https://www.python.org/dev/peps/pep-0395/#fixing-dual-imports-of-the-main-module</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id14">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>


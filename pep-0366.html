<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">366</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Main module explicit relative imports</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0366.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Nick Coghlan &lt;ncoghlan&#32;&#97;t&#32;gmail.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">1-May-2007</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">2.6, 3.0</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">1-May-2007, 4-Jul-2007, 7-Jul-2007, 23-Nov-2007</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id10">Abstract</a></li>
<li><a class="reference internal" href="#proposed-change" id="id11">Proposed Change</a></li>
<li><a class="reference internal" href="#rationale-for-change" id="id12">Rationale for Change</a></li>
<li><a class="reference internal" href="#reference-implementation" id="id13">Reference Implementation</a></li>
<li><a class="reference internal" href="#alternative-proposals" id="id14">Alternative Proposals</a></li>
<li><a class="reference internal" href="#references" id="id15">References</a></li>
<li><a class="reference internal" href="#copyright" id="id16">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id10">Abstract</a></h1>
<p>This PEP proposes a backwards compatible mechanism that permits
the use of explicit relative imports from executable modules within
packages. Such imports currently fail due to an awkward interaction
between <a class="reference external" href="/dev/peps/pep-0328">PEP 328</a> and <a class="reference external" href="/dev/peps/pep-0338">PEP 338</a>.</p>
<p>By adding a new module level attribute, this PEP allows relative imports
to work automatically if the module is executed using the <tt class="docutils literal"><span class="pre">-m</span></tt> switch.
A small amount of boilerplate in the module itself will allow the relative
imports to work when the file is executed by name.</p>
<p>Guido accepted the PEP in November 2007 <a class="footnote-reference" href="#id9" id="id1">[5]</a>.</p>
</div>
<div class="section" id="proposed-change">
<h1><a class="toc-backref" href="#id11">Proposed Change</a></h1>
<p>The major proposed change is the introduction of a new module level
attribute, <tt class="docutils literal">__package__</tt>. When it is present, relative imports will
be based on this attribute rather than the module <tt class="docutils literal">__name__</tt>
attribute.</p>
<p>As with the current <tt class="docutils literal">__name__</tt> attribute, setting <tt class="docutils literal">__package__</tt> will
be the responsibility of the <a class="reference external" href="/dev/peps/pep-0302">PEP 302</a> loader used to import a module.
Loaders which use <tt class="docutils literal">imp.new_module()</tt> to create the module object will
have the new attribute set automatically to <tt class="docutils literal">None</tt>. When the import
system encounters an explicit relative import in a module without
<tt class="docutils literal">__package__</tt> set (or with it set to <tt class="docutils literal">None</tt>), it will calculate and
store the correct value (<tt class="docutils literal"><span class="pre">__name__.rpartition('.')[0]</span></tt> for normal
modules and <tt class="docutils literal">__name__</tt> for package initialisation modules). If
<tt class="docutils literal">__package__</tt> has already been set then the import system will use
it in preference to recalculating the package name from the
<tt class="docutils literal">__name__</tt> and <tt class="docutils literal">__path__</tt> attributes.</p>
<p>The <tt class="docutils literal">runpy</tt> module will explicitly set the new attribute, basing it off
the name used to locate the module to be executed rather than the name
used to set the module's <tt class="docutils literal">__name__</tt> attribute. This will allow relative
imports to work correctly from main modules executed with the <tt class="docutils literal"><span class="pre">-m</span></tt>
switch.</p>
<p>When the main module is specified by its filename, then the
<tt class="docutils literal">__package__</tt> attribute will be set to <tt class="docutils literal">None</tt>. To allow
relative imports when the module is executed directly, boilerplate
similar to the following would be needed before the first relative
import statement:</p>
<pre class="literal-block">
if __name__ == &quot;__main__&quot; and __package__ is None:
    __package__ = &quot;expected.package.name&quot;
</pre>
<p>Note that this boilerplate is sufficient only if the top level package
is already accessible via <tt class="docutils literal">sys.path</tt>. Additional code that manipulates
<tt class="docutils literal">sys.path</tt> would be needed in order for direct execution to work
without the top level package already being importable.</p>
<p>This approach also has the same disadvantage as the use of absolute
imports of sibling modules - if the script is moved to a different
package or subpackage, the boilerplate will need to be updated
manually. It has the advantage that this change need only be made
once per file, regardless of the number of relative imports.</p>
<p>Note that setting <tt class="docutils literal">__package__</tt> to the empty string explicitly is
permitted, and has the effect of disabling all relative imports from
that module (since the import machinery will consider it to be a
top level module in that case). This means that tools like <tt class="docutils literal">runpy</tt>
do not need to provide special case handling for top level modules
when setting <tt class="docutils literal">__package__</tt>.</p>
</div>
<div class="section" id="rationale-for-change">
<h1><a class="toc-backref" href="#id12">Rationale for Change</a></h1>
<p>The current inability to use explicit relative imports from the main
module is the subject of at least one open SF bug report (#1510172) <a class="footnote-reference" href="#id5" id="id2">[1]</a>,
and has most likely been a factor in at least a few queries on
comp.lang.python (such as Alan Isaac's question in <a class="footnote-reference" href="#id6" id="id3">[2]</a>).</p>
<p>This PEP is intended to provide a solution which permits explicit
relative imports from main modules, without incurring any significant
costs during interpreter startup or normal module import.</p>
<p>The section in <a class="reference external" href="/dev/peps/pep-0338">PEP 338</a> on relative imports and the main module provides
further details and background on this problem.</p>
</div>
<div class="section" id="reference-implementation">
<h1><a class="toc-backref" href="#id13">Reference Implementation</a></h1>
<p>Rev 47142 in SVN implemented an early variant of this proposal
which stored the main module's real module name in the
<tt class="docutils literal">__module_name__</tt> attribute. It was reverted due to the fact
that 2.5 was already in beta by that time.</p>
<p>Patch 1487 [4] is the proposed implementation for this PEP.</p>
</div>
<div class="section" id="alternative-proposals">
<h1><a class="toc-backref" href="#id14">Alternative Proposals</a></h1>
<p><a class="reference external" href="/dev/peps/pep-3122">PEP 3122</a> proposed addressing this problem by changing the way
the main module is identified. That's a significant compatibility cost
to incur to fix something that is a pretty minor bug in the overall
scheme of things, and the PEP was rejected <a class="footnote-reference" href="#id7" id="id4">[3]</a>.</p>
<p>The advantage of the proposal in this PEP is that its only impact on
normal code is the small amount of time needed to set the extra
attribute when importing a module. Relative imports themselves should
be sped up fractionally, as the package name is cached in the module
globals, rather than having to be worked out again for each relative
import.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id15">References</a></h1>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>Absolute/relative import not working?
(<a class="reference external" href="http://www.python.org/sf/1510172">http://www.python.org/sf/1510172</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>c.l.p. question about modules and relative imports
(<a class="reference external" href="http://groups.google.com/group/comp.lang.python/browse_thread/thread/c44c769a72ca69fa/">http://groups.google.com/group/comp.lang.python/browse_thread/thread/c44c769a72ca69fa/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>Guido's rejection of <a class="reference external" href="/dev/peps/pep-3122">PEP 3122</a>
(<a class="reference external" href="https://mail.python.org/pipermail/python-3000/2007-April/006793.html">https://mail.python.org/pipermail/python-3000/2007-April/006793.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><a class="reference external" href="/dev/peps/pep-0366">PEP 366</a> implementation patch
(<a class="reference external" href="http://bugs.python.org/issue1487">http://bugs.python.org/issue1487</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[5]</a></td><td>Acceptance of the PEP
(<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2007-November/075475.html">https://mail.python.org/pipermail/python-dev/2007-November/075475.html</a>)</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id16">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
End: -->
</div>


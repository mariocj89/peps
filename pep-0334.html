<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">334</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Simple Coroutines via SuspendIteration</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0334.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Clark C. Evans &lt;cce&#32;&#97;t&#32;clarkevans.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Withdrawn</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">26-Aug-2004</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.0</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id21">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id22">Rationale</a></li>
<li><a class="reference internal" href="#semantics" id="id23">Semantics</a><ul>
<li><a class="reference internal" href="#simple-iterators" id="id24">Simple Iterators</a></li>
<li><a class="reference internal" href="#introducing-suspenditeration" id="id25">Introducing SuspendIteration</a></li>
<li><a class="reference internal" href="#application-iterators" id="id26">Application Iterators</a></li>
<li><a class="reference internal" href="#complicating-factors" id="id27">Complicating Factors</a></li>
<li><a class="reference internal" href="#resource-cleanup" id="id28">Resource Cleanup</a></li>
<li><a class="reference internal" href="#api-and-limitations" id="id29">API and Limitations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#low-level-implementation" id="id30">Low-Level Implementation</a></li>
<li><a class="reference internal" href="#references" id="id31">References</a></li>
<li><a class="reference internal" href="#copyright" id="id32">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id21">Abstract</a></h1>
<p>Asynchronous application frameworks such as Twisted <a class="footnote-reference" href="#id11" id="id1">[1]</a> and Peak
<a class="footnote-reference" href="#id12" id="id2">[2]</a>, are based on a cooperative multitasking via event queues or
deferred execution.  While this approach to application development
does not involve threads and thus avoids a whole class of problems
<a class="footnote-reference" href="#id13" id="id3">[3]</a>, it creates a different sort of programming challenge.  When an
I/O operation would block, a user request must suspend so that other
requests can proceed.  The concept of a coroutine <a class="footnote-reference" href="#id14" id="id4">[4]</a> promises to
help the application developer grapple with this state management
difficulty.</p>
<p>This PEP proposes a limited approach to coroutines based on an
extension to the iterator protocol <a class="footnote-reference" href="#id15" id="id5">[5]</a>.  Currently, an iterator may
raise a StopIteration exception to indicate that it is done producing
values.  This proposal adds another exception to this protocol,
SuspendIteration, which indicates that the given iterator may have
more values to produce, but is unable to do so at this time.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id22">Rationale</a></h1>
<p>There are two current approaches to bringing co-routines to Python.
Christian Tismer's Stackless <a class="footnote-reference" href="#id16" id="id6">[6]</a> involves a ground-up restructuring
of Python's execution model by hacking the 'C' stack.  While this
approach works, its operation is hard to describe and keep portable. A
related approach is to compile Python code to Parrot <a class="footnote-reference" href="#id17" id="id7">[7]</a>, a
register-based virtual machine, which has coroutines.  Unfortunately,
neither of these solutions is portable with IronPython (CLR) or Jython
(JavaVM).</p>
<p>It is thought that a more limited approach, based on iterators, could
provide a coroutine facility to application programmers and still be
portable across runtimes.</p>
<ul class="simple">
<li>Iterators keep their state in local variables that are not on the
&quot;C&quot; stack.  Iterators can be viewed as classes, with state stored in
member variables that are persistent across calls to its next()
method.</li>
<li>While an uncaught exception may terminate a function's execution, an
uncaught exception need not invalidate an iterator.  The proposed
exception, SuspendIteration, uses this feature.  In other words,
just because one call to next() results in an exception does not
necessarily need to imply that the iterator itself is no longer
capable of producing values.</li>
</ul>
<p>There are four places where this new exception impacts:</p>
<ul class="simple">
<li>The simple generator <a class="footnote-reference" href="#id18" id="id8">[8]</a> mechanism could be extended to safely
'catch' this SuspendIteration exception, stuff away its current
state, and pass the exception on to the caller.</li>
<li>Various iterator filters <a class="footnote-reference" href="#id19" id="id9">[9]</a> in the standard library, such as
itertools.izip should be made aware of this exception so that it can
transparently propagate SuspendIteration.</li>
<li>Iterators generated from I/O operations, such as a file or socket
reader, could be modified to have a non-blocking variety.  This
option would raise a subclass of SuspendIteration if the requested
operation would block.</li>
<li>The asyncore library could be updated to provide a basic 'runner'
that pulls from an iterator; if the SuspendIteration exception is
caught, then it moves on to the next iterator in its runlist <a class="footnote-reference" href="#id20" id="id10">[10]</a>.
External frameworks like Twisted would provide alternative
implementations, perhaps based on FreeBSD's kqueue or Linux's epoll.</li>
</ul>
<p>While these may seem dramatic changes, it is a very small amount of
work compared with the utility provided by continuations.</p>
</div>
<div class="section" id="semantics">
<h1><a class="toc-backref" href="#id23">Semantics</a></h1>
<p>This section will explain, at a high level, how the introduction of
this new SuspendIteration exception would behave.</p>
<div class="section" id="simple-iterators">
<h2><a class="toc-backref" href="#id24">Simple Iterators</a></h2>
<p>The current functionality of iterators is best seen with a simple
example which produces two values 'one' and 'two'.</p>
<pre class="literal-block">
class States:

    def __iter__(self):
        self._next = self.state_one
        return self

    def next(self):
        return self._next()

    def state_one(self):
        self._next = self.state_two
        return &quot;one&quot;

    def state_two(self):
        self._next = self.state_stop
        return &quot;two&quot;

    def state_stop(self):
        raise StopIteration

print list(States())
</pre>
<p>An equivalent iteration could, of course, be created by the
following generator:</p>
<pre class="literal-block">
def States():
    yield 'one'
    yield 'two'

print list(States())
</pre>
</div>
<div class="section" id="introducing-suspenditeration">
<h2><a class="toc-backref" href="#id25">Introducing SuspendIteration</a></h2>
<p>Suppose that between producing 'one' and 'two', the generator above
could block on a socket read.  In this case, we would want to raise
SuspendIteration to signal that the iterator is not done producing,
but is unable to provide a value at the current moment.</p>
<pre class="literal-block">
from random import randint
from time import sleep

class SuspendIteration(Exception):
      pass

class NonBlockingResource:

    &quot;&quot;&quot;Randomly unable to produce the second value&quot;&quot;&quot;

    def __iter__(self):
        self._next = self.state_one
        return self

    def next(self):
        return self._next()

    def state_one(self):
        self._next = self.state_suspend
        return &quot;one&quot;

    def state_suspend(self):
        rand = randint(1,10)
        if 2 == rand:
            self._next = self.state_two
            return self.state_two()
        raise SuspendIteration()

    def state_two(self):
        self._next = self.state_stop
        return &quot;two&quot;

    def state_stop(self):
        raise StopIteration

def sleeplist(iterator, timeout = .1):
    &quot;&quot;&quot;
    Do other things (e.g. sleep) while resource is
    unable to provide the next value
    &quot;&quot;&quot;
    it = iter(iterator)
    retval = []
    while True:
        try:
            retval.append(it.next())
        except SuspendIteration:
            sleep(timeout)
            continue
        except StopIteration:
            break
    return retval

print sleeplist(NonBlockingResource())
</pre>
<p>In a real-world situation, the NonBlockingResource would be a file
iterator, socket handle, or other I/O based producer.  The sleeplist
would instead be an async reactor, such as those found in asyncore or
Twisted.  The non-blocking resource could, of course, be written as a
generator:</p>
<pre class="literal-block">
def NonBlockingResource():
    yield &quot;one&quot;
    while True:
        rand = randint(1,10)
        if 2 == rand:
            break
        raise SuspendIteration()
    yield &quot;two&quot;
</pre>
<p>It is not necessary to add a keyword, 'suspend', since most real
content generators will not be in application code, they will be in
low-level I/O based operations.  Since most programmers need not be
exposed to the SuspendIteration() mechanism, a keyword is not needed.</p>
</div>
<div class="section" id="application-iterators">
<h2><a class="toc-backref" href="#id26">Application Iterators</a></h2>
<p>The previous example is rather contrived, a more 'real-world' example
would be a web page generator which yields HTML content, and pulls
from a database.  Note that this is an example of neither the
'producer' nor the 'consumer', but rather of a filter.</p>
<pre class="literal-block">
def ListAlbums(cursor):
    cursor.execute(&quot;SELECT title, artist FROM album&quot;)
    yield '&lt;html&gt;&lt;body&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;Title&lt;/td&gt;&lt;td&gt;Artist&lt;/td&gt;&lt;/tr&gt;'
    for (title, artist) in cursor:
        yield '&lt;tr&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;' % (title, artist)
    yield '&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;'
</pre>
<p>The problem, of course, is that the database may block for some time
before any rows are returned, and that during execution, rows may be
returned in blocks of 10 or 100 at a time. Ideally, if the database
blocks for the next set of rows, another user connection could be
serviced.  Note the complete absence of SuspendIterator in the above
code.  If done correctly, application developers would be able to
focus on functionality rather than concurrency issues.</p>
<p>The iterator created by the above generator should do the magic
necessary to maintain state, yet pass the exception through to a
lower-level async framework.  Here is an example of what the
corresponding iterator would look like if coded up as a class:</p>
<pre class="literal-block">
class ListAlbums:

    def __init__(self, cursor):
        self.cursor = cursor

    def __iter__(self):
        self.cursor.execute(&quot;SELECT title, artist FROM album&quot;)
        self._iter = iter(self._cursor)
        self._next = self.state_head
        return self

    def next(self):
        return self._next()

    def state_head(self):
        self._next = self.state_cursor
        return &quot;&lt;html&gt;&lt;body&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;\
                Title&lt;/td&gt;&lt;td&gt;Artist&lt;/td&gt;&lt;/tr&gt;&quot;

    def state_tail(self):
        self._next = self.state_stop
        return &quot;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;&quot;

    def state_cursor(self):
        try:
            (title,artist) = self._iter.next()
            return '&lt;tr&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;' % (title, artist)
        except StopIteration:
            self._next = self.state_tail
            return self.next()
        except SuspendIteration:
            # just pass-through
            raise

    def state_stop(self):
        raise StopIteration
</pre>
</div>
<div class="section" id="complicating-factors">
<h2><a class="toc-backref" href="#id27">Complicating Factors</a></h2>
<p>While the above example is straightforward, things are a bit more
complicated if the intermediate generator 'condenses' values, that is,
it pulls in two or more values for each value it produces. For
example,</p>
<pre class="literal-block">
def pair(iterLeft,iterRight):
    rhs = iter(iterRight)
    lhs = iter(iterLeft)
    while True:
       yield (rhs.next(), lhs.next())
</pre>
<p>In this case, the corresponding iterator behavior has to be a bit more
subtle to handle the case of either the right or left iterator raising
SuspendIteration.  It seems to be a matter of decomposing the
generator to recognize intermediate states where a SuspendIterator
exception from the producing context could happen.</p>
<pre class="literal-block">
class pair:

    def __init__(self, iterLeft, iterRight):
        self.iterLeft = iterLeft
        self.iterRight = iterRight

    def __iter__(self):
        self.rhs = iter(iterRight)
        self.lhs = iter(iterLeft)
        self._temp_rhs = None
        self._temp_lhs = None
        self._next = self.state_rhs
        return self

    def next(self):
        return self._next()

    def state_rhs(self):
        self._temp_rhs = self.rhs.next()
        self._next = self.state_lhs
        return self.next()

    def state_lhs(self):
        self._temp_lhs = self.lhs.next()
        self._next = self.state_pair
        return self.next()

    def state_pair(self):
        self._next = self.state_rhs
        return (self._temp_rhs, self._temp_lhs)
</pre>
<p>This proposal assumes that a corresponding iterator written using
this class-based method is possible for existing generators.  The
challenge seems to be the identification of distinct states within
the generator where suspension could occur.</p>
</div>
<div class="section" id="resource-cleanup">
<h2><a class="toc-backref" href="#id28">Resource Cleanup</a></h2>
<p>The current generator mechanism has a strange interaction with
exceptions where a 'yield' statement is not allowed within a
try/finally block.  The SuspendIterator exception provides another
similar issue.  The impacts of this issue are not clear. However it
may be that re-writing the generator into a state machine, as the
previous section did, could resolve this issue allowing for the
situation to be no-worse than, and perhaps even removing the
yield/finally situation.  More investigation is needed in this area.</p>
</div>
<div class="section" id="api-and-limitations">
<h2><a class="toc-backref" href="#id29">API and Limitations</a></h2>
<p>This proposal only covers 'suspending' a chain of iterators, and does
not cover (of course) suspending general functions, methods, or &quot;C&quot;
extension function.  While there could be no direct support for
creating generators in &quot;C&quot; code, native &quot;C&quot; iterators which comply
with the SuspendIterator semantics are certainly possible.</p>
</div>
</div>
<div class="section" id="low-level-implementation">
<h1><a class="toc-backref" href="#id30">Low-Level Implementation</a></h1>
<p>The author of the PEP is not yet familiar with the Python execution
model to comment in this area.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id31">References</a></h1>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Twisted
(<a class="reference external" href="http://twistedmatrix.com">http://twistedmatrix.com</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Peak
(<a class="reference external" href="http://peak.telecommunity.com">http://peak.telecommunity.com</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>C10K
(<a class="reference external" href="http://www.kegel.com/c10k.html">http://www.kegel.com/c10k.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>Coroutines
(<a class="reference external" href="http://c2.com/cgi/wiki?CallWithCurrentContinuation">http://c2.com/cgi/wiki?CallWithCurrentContinuation</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="/dev/peps/pep-0234">PEP 234</a>, Iterators
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0234/">http://www.python.org/dev/peps/pep-0234/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td>Stackless Python
(<a class="reference external" href="http://stackless.com">http://stackless.com</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td>Parrot /w coroutines
(<a class="reference external" href="http://www.sidhe.org/~dan/blog/archives/000178.html">http://www.sidhe.org/~dan/blog/archives/000178.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id18" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td><a class="reference external" href="/dev/peps/pep-0255">PEP 255</a>, Simple Generators
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0255/">http://www.python.org/dev/peps/pep-0255/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[9]</a></td><td>itertools - Functions creating iterators
(<a class="reference external" href="http://docs.python.org/library/itertools.html">http://docs.python.org/library/itertools.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id20" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[10]</a></td><td>Microthreads in Python, David Mertz
(<a class="reference external" href="http://www-106.ibm.com/developerworks/linux/library/l-pythrd.html">http://www-106.ibm.com/developerworks/linux/library/l-pythrd.html</a>)</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id32">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
End: -->
</div>


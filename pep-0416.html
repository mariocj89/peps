<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">416</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Add a frozendict builtin type</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0416.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Victor Stinner &lt;victor.stinner&#32;&#97;t&#32;gmail.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Rejected</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">29-February-2012</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.3</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#rejection-notice" id="id5">Rejection Notice</a></li>
<li><a class="reference internal" href="#abstract" id="id6">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id7">Rationale</a></li>
<li><a class="reference internal" href="#constraints" id="id8">Constraints</a></li>
<li><a class="reference internal" href="#implementation" id="id9">Implementation</a></li>
<li><a class="reference internal" href="#recipe-hashable-dict" id="id10">Recipe: hashable dict</a></li>
<li><a class="reference internal" href="#objections" id="id11">Objections</a></li>
<li><a class="reference internal" href="#alternative-dictproxy" id="id12">Alternative: dictproxy</a></li>
<li><a class="reference internal" href="#existing-implementations" id="id13">Existing implementations</a></li>
<li><a class="reference internal" href="#links" id="id14">Links</a></li>
<li><a class="reference internal" href="#id2" id="id15">References</a></li>
<li><a class="reference internal" href="#copyright" id="id16">Copyright</a></li>
</ul>
</div>
<div class="section" id="rejection-notice">
<h1><a class="toc-backref" href="#id5">Rejection Notice</a></h1>
<p>I'm rejecting this PEP.  A number of reasons (not exhaustive):</p>
<ul class="simple">
<li>According to Raymond Hettinger, use of frozendict is low.  Those
that do use it tend to use it as a hint only, such as declaring
global or class-level &quot;constants&quot;: they aren't really immutable,
since anyone can still assign to the name.</li>
<li>There are existing idioms for avoiding mutable default values.</li>
<li>The potential of optimizing code using frozendict in PyPy is
unsure; a lot of other things would have to change first.  The same
holds for compile-time lookups in general.</li>
<li>Multiple threads can agree by convention not to mutate a shared
dict, there's no great need for enforcement.  Multiple processes
can't share dicts.</li>
<li>Adding a security sandbox written in Python, even with a limited
scope, is frowned upon by many, due to the inherent difficulty with
ever proving that the sandbox is actually secure.  Because of this
we won't be adding one to the stdlib any time soon, so this use
case falls outside the scope of a PEP.</li>
</ul>
<p>On the other hand, exposing the existing read-only dict proxy as a
built-in type sounds good to me.  (It would need to be changed to
allow calling the constructor.)  GvR.</p>
<p><strong>Update</strong> (2012-04-15): A new <tt class="docutils literal">MappingProxyType</tt> type was added to the types
module of Python 3.3.</p>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id6">Abstract</a></h1>
<p>Add a new frozendict builtin type.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id7">Rationale</a></h1>
<p>A frozendict is a read-only mapping: a key cannot be added nor removed, and a
key is always mapped to the same value. However, frozendict values can be not
hashable. A frozendict is hashable if and only if all values are hashable.</p>
<p>Use cases:</p>
<ul class="simple">
<li>Immutable global variable like a default configuration.</li>
<li>Default value of a function parameter. Avoid the issue of mutable default
arguments.</li>
<li>Implement a cache: frozendict can be used to store function keywords.
frozendict can be used as a key of a mapping or as a member of set.</li>
<li>frozendict avoids the need of a lock when the frozendict is shared
by multiple threads or processes, especially hashable frozendict. It would
also help to prohibe coroutines (generators + greenlets) to modify the
global state.</li>
<li>frozendict lookup can be done at compile time instead of runtime because the
mapping is read-only. frozendict can be used instead of a preprocessor to
remove conditional code at compilation, like code specific to a debug build.</li>
<li>frozendict helps to implement read-only object proxies for security modules.
For example, it would be possible to use frozendict type for __builtins__
mapping or type.__dict__. This is possible because frozendict is compatible
with the PyDict C API.</li>
<li>frozendict avoids the need of a read-only proxy in some cases. frozendict is
faster than a proxy because getting an item in a frozendict is a fast lookup
whereas a proxy requires a function call.</li>
</ul>
</div>
<div class="section" id="constraints">
<h1><a class="toc-backref" href="#id8">Constraints</a></h1>
<ul class="simple">
<li>frozendict has to implement the Mapping abstract base class</li>
<li>frozendict keys and values can be unorderable</li>
<li>a frozendict is hashable if all keys and values are hashable</li>
<li>frozendict hash does not depend on the items creation order</li>
</ul>
</div>
<div class="section" id="implementation">
<h1><a class="toc-backref" href="#id9">Implementation</a></h1>
<ul class="simple">
<li>Add a PyFrozenDictObject structure based on PyDictObject with an extra
&quot;Py_hash_t hash;&quot; field</li>
<li>frozendict.__hash__() is implemented using hash(frozenset(self.items())) and
caches the result in its private hash attribute</li>
<li>Register frozendict as a collections.abc.Mapping</li>
<li>frozendict can be used with PyDict_GetItem(), but PyDict_SetItem() and
PyDict_DelItem() raise a TypeError</li>
</ul>
</div>
<div class="section" id="recipe-hashable-dict">
<h1><a class="toc-backref" href="#id10">Recipe: hashable dict</a></h1>
<p>To ensure that a frozendict is hashable, values can be checked
before creating the frozendict:</p>
<pre class="literal-block">
import itertools

def hashabledict(*args, **kw):
    # ensure that all values are hashable
    for key, value in itertools.chain(args, kw.items()):
        if isinstance(value, (int, str, bytes, float, frozenset, complex)):
            # avoid the compute the hash (which may be slow) for builtin
            # types known to be hashable for any value
            continue
        hash(value)
        # don't check the key: frozendict already checks the key
    return frozendict.__new__(cls, *args, **kw)
</pre>
</div>
<div class="section" id="objections">
<h1><a class="toc-backref" href="#id11">Objections</a></h1>
<p><em>namedtuple may fit the requirements of a frozendict.</em></p>
<p>A namedtuple is not a mapping, it does not implement the Mapping abstract base
class.</p>
<p><em>frozendict can be implemented in Python using descriptors&quot; and &quot;frozendict
just need to be practically constant.</em></p>
<p>If frozendict is used to harden Python (security purpose), it must be
implemented in C. A type implemented in C is also faster.</p>
<p><em>The PEP 351 was rejected.</em></p>
<p>The <a class="reference external" href="/dev/peps/pep-0351">PEP 351</a> tries to freeze an object and so may convert a mutable object to an
immutable object (using a different type). frozendict doesn't convert anything:
hash(frozendict) raises a TypeError if a value is not hashable. Freezing an
object is not the purpose of this PEP.</p>
</div>
<div class="section" id="alternative-dictproxy">
<h1><a class="toc-backref" href="#id12">Alternative: dictproxy</a></h1>
<p>Python has a builtin dictproxy type used by type.__dict__ getter descriptor.
This type is not public. dictproxy is a read-only view of a dictionary, but it
is not read-only mapping.  If a dictionary is modified, the dictproxy is also
modified.</p>
<p>dictproxy can be used using ctypes and the Python C API, see for example the
<a class="reference external" href="http://code.activestate.com/recipes/576540/">make dictproxy object via ctypes.pythonapi and type() (Python recipe 576540)</a> <a class="footnote-reference" href="#id3" id="id4">[1]</a>
by Ikkei Shimomura. The recipe contains a test checking that a dictproxy is
&quot;mutable&quot; (modify the dictionary linked to the dictproxy).</p>
<p>However dictproxy can be useful in some cases, where its mutable property is
not an issue, to avoid a copy of the dictionary.</p>
</div>
<div class="section" id="existing-implementations">
<h1><a class="toc-backref" href="#id13">Existing implementations</a></h1>
<p>Whitelist approach.</p>
<ul class="simple">
<li><a class="reference external" href="http://code.activestate.com/recipes/498072/">Implementing an Immutable Dictionary (Python recipe 498072)</a> by Aristotelis Mikropoulos.
Similar to frozendict except that it is not truly read-only: it is possible
to access to this private internal dict.  It does not implement __hash__ and
has an implementation issue: it is possible to call again __init__() to
modify the mapping.</li>
<li>PyWebmail contains an ImmutableDict type: <a class="reference external" href="http://pywebmail.cvs.sourceforge.net/viewvc/pywebmail/webmail/webmail/utils/ImmutableDict.py?revision=1.2&amp;view=markup">webmail.utils.ImmutableDict</a>.
It is hashable if keys and values are hashable. It is not truly read-only:
its internal dict is a public attribute.</li>
<li>remember project: <a class="reference external" href="https://bitbucket.org/mikegraham/remember/src/tip/remember/dicts.py">remember.dicts.FrozenDict</a>.
It is used to implement a cache: FrozenDict is used to store function callbacks.
FrozenDict may be hashable. It has an extra supply_dict() class method to
create a FrozenDict from a dict without copying the dict: store the dict as
the internal dict. Implementation issue: __init__() can be called to modify
the mapping and the hash may differ depending on item creation order. The
mapping is not truly read-only: the internal dict is accessible in Python.</li>
</ul>
<p>Blacklist approach: inherit from dict and override write methods to raise an
exception. It is not truly read-only: it is still possible to call dict methods
on such &quot;frozen dictionary&quot; to modify it.</p>
<ul class="simple">
<li>brownie: <a class="reference external" href="https://github.com/DasIch/brownie/blob/HEAD/brownie/datastructures/mappings.py">brownie.datastructures.ImmuatableDict</a>.
It is hashable if keys and values are hashable. werkzeug project has the
same code: <a class="reference external" href="https://github.com/mitsuhiko/werkzeug/blob/master/werkzeug/datastructures.py">werkzeug.datastructures.ImmutableDict</a>.
ImmutableDict is used for global constant (configuration options). The Flask
project uses ImmutableDict of werkzeug for its default configuration.</li>
<li>SQLAchemy project: <a class="reference external" href="http://hg.sqlalchemy.org/sqlalchemy/file/tip/lib/sqlalchemy/util/_collections.py">sqlachemy.util.immutabledict</a>.
It is not hashable and has an extra method: union(). immutabledict is used
for the default value of parameter of some functions expecting a mapping.
Example: mapper_args=immutabledict() in SqlSoup.map().</li>
<li><a class="reference external" href="http://code.activestate.com/recipes/414283/">Frozen dictionaries (Python recipe 414283)</a>
by Oren Tirosh. It is hashable if keys and values are hashable. Included in
the following projects:<ul>
<li>lingospot: <a class="reference external" href="http://code.google.com/p/lingospot/source/browse/trunk/frozendict/frozendict.py">frozendict/frozendict.py</a></li>
<li>factor-graphics: frozendict type in <a class="reference external" href="https://github.com/ih/factor-graphics/blob/41006fb71a09377445cc140489da5ce8eeb9c8b1/python/fglib/util_ext_frozendict.py">python/fglib/util_ext_frozendict.py</a></li>
</ul>
</li>
<li>The gsakkis-utils project written by George Sakkis includes a frozendict
type: <a class="reference external" href="http://code.google.com/p/gsakkis-utils/source/browse/trunk/datastructs/frozendict.py">datastructs.frozendict</a></li>
<li>characters: <a class="reference external" href="https://github.com/JasonGross/characters/blob/15a2af5f7861cd33a0dbce70f1569cda74e9a1e3/scripts/python/frozendict.py#L1">scripts/python/frozendict.py</a>.
It is hashable. __init__() sets __init__ to None.</li>
<li>Old NLTK (1.x): <a class="reference external" href="http://nltk.googlecode.com/svn/trunk/nltk-old/src/nltk/util.py">nltk.util.frozendict</a>. Keys and
values must be hashable. __init__() can be called twice to modify the
mapping. frozendict is used to &quot;freeze&quot; an object.</li>
</ul>
<p>Hashable dict: inherit from dict and just add an __hash__ method.</p>
<ul class="simple">
<li><a class="reference external" href="https://bitbucket.org/pypy/pypy/src/1f49987cc2fe/pypy/rpython/lltypesystem/lltype.py#cl-86">pypy.rpython.lltypesystem.lltype.frozendict</a>.
It is hashable but don't deny modification of the mapping.</li>
<li>factor-graphics: hashabledict type in <a class="reference external" href="https://github.com/ih/factor-graphics/blob/41006fb71a09377445cc140489da5ce8eeb9c8b1/python/fglib/util_ext_frozendict.py">python/fglib/util_ext_frozendict.py</a></li>
</ul>
</div>
<div class="section" id="links">
<h1><a class="toc-backref" href="#id14">Links</a></h1>
<ul class="simple">
<li><a class="reference external" href="http://bugs.python.org/issue14162">Issue #14162: PEP 416: Add a builtin frozendict type</a></li>
<li><a class="reference external" href="/dev/peps/pep-0412">PEP 412</a>: Key-Sharing Dictionary
(<a class="reference external" href="http://bugs.python.org/issue13903">issue #13903</a>)</li>
<li><a class="reference external" href="/dev/peps/pep-0351">PEP 351</a>: The freeze protocol</li>
<li><a class="reference external" href="http://www.cs.toronto.edu/~tijmen/programming/immutableDictionaries.html">The case for immutable dictionaries; and the central misunderstanding of
PEP 351</a></li>
<li><a class="reference external" href="http://code.activestate.com/recipes/576540/">make dictproxy object via ctypes.pythonapi and type() (Python recipe
576540)</a> by Ikkei Shimomura.</li>
<li>Python security modules implementing read-only object proxies using a C
extension:<ul>
<li><a class="reference external" href="https://github.com/vstinner/pysandbox/">pysandbox</a></li>
<li><a class="reference external" href="http://www.egenix.com/products/python/mxBase/mxProxy/">mxProxy</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/zope.proxy">zope.proxy</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/zope.security">zope.security</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id2">
<h1><a class="toc-backref" href="#id15">References</a></h1>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[1]</a></td><td><a class="reference external" href="http://code.activestate.com/recipes/576540/">http://code.activestate.com/recipes/576540/</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id16">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
</div>


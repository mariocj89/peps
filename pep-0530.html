<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">530</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Asynchronous Comprehensions</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0530.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Yury Selivanov &lt;yury&#32;&#97;t&#32;magic.io&gt;</td>
</tr>
<tr class="field"><th class="field-name">Discussions-To:</th><td class="field-body">&lt;<a class="reference external" href="mailto:python-dev&#64;python.org?subject=PEP%20530">python-dev&#32;&#97;t&#32;python.org</a>&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">03-Sep-2016</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.6</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">03-Sep-2016</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id7">Abstract</a></li>
<li><a class="reference internal" href="#rationale-and-goals" id="id8">Rationale and Goals</a></li>
<li><a class="reference internal" href="#specification" id="id9">Specification</a><ul>
<li><a class="reference internal" href="#asynchronous-comprehensions" id="id10">Asynchronous Comprehensions</a></li>
<li><a class="reference internal" href="#await-in-comprehensions" id="id11"><tt class="docutils literal">await</tt> in Comprehensions</a></li>
<li><a class="reference internal" href="#grammar-updates" id="id12">Grammar Updates</a></li>
<li><a class="reference internal" href="#backwards-compatibility" id="id13">Backwards Compatibility</a></li>
</ul>
</li>
<li><a class="reference internal" href="#acceptance" id="id14">Acceptance</a></li>
<li><a class="reference internal" href="#implementation" id="id15">Implementation</a></li>
<li><a class="reference internal" href="#references" id="id16">References</a></li>
<li><a class="reference internal" href="#acknowledgments" id="id17">Acknowledgments</a></li>
<li><a class="reference internal" href="#copyright" id="id18">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id7">Abstract</a></h1>
<p><a class="reference external" href="/dev/peps/pep-0492">PEP 492</a> and <a class="reference external" href="/dev/peps/pep-0525">PEP 525</a> introduce support for native coroutines and
asynchronous generators using <tt class="docutils literal">async</tt> / <tt class="docutils literal">await</tt> syntax.  This PEP
proposes to add asynchronous versions of list, set, dict comprehensions
and generator expressions.</p>
</div>
<div class="section" id="rationale-and-goals">
<h1><a class="toc-backref" href="#id8">Rationale and Goals</a></h1>
<p>Python has extensive support for synchronous comprehensions, allowing
to produce lists, dicts, and sets with a simple and concise syntax.  We
propose implementing similar syntactic constructions for the
asynchronous code.</p>
<p>To illustrate the readability improvement, consider the following
example:</p>
<pre class="literal-block">
result = []
async for i in aiter():
    if i % 2:
        result.append(i)
</pre>
<p>With the proposed asynchronous comprehensions syntax, the above code
becomes as short as:</p>
<pre class="literal-block">
result = [i async for i in aiter() if i % 2]
</pre>
<p>The PEP also makes it possible to use the <tt class="docutils literal">await</tt> expressions in
all kinds of comprehensions:</p>
<pre class="literal-block">
result = [await fun() for fun in funcs]
</pre>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id9">Specification</a></h1>
<div class="section" id="asynchronous-comprehensions">
<h2><a class="toc-backref" href="#id10">Asynchronous Comprehensions</a></h2>
<p>We propose to allow using <tt class="docutils literal">async for</tt> inside list, set and dict
comprehensions.  Pending <a class="reference external" href="/dev/peps/pep-0525">PEP 525</a> approval, we can also allow creation
of asynchronous generator expressions.</p>
<p>Examples:</p>
<ul class="simple">
<li>set comprehension: <tt class="docutils literal">{i async for i in <span class="pre">agen()}</span></tt>;</li>
<li>list comprehension: <tt class="docutils literal">[i async for i in <span class="pre">agen()]</span></tt>;</li>
<li>dict comprehension: <tt class="docutils literal">{i: i ** 2 async for i in <span class="pre">agen()}</span></tt>;</li>
<li>generator expression: <tt class="docutils literal">(i ** 2 async for i in <span class="pre">agen())</span></tt>.</li>
</ul>
<p>It is allowed to use <tt class="docutils literal">async for</tt> along with  <tt class="docutils literal">if</tt> and <tt class="docutils literal">for</tt>
clauses in asynchronous comprehensions and generator expressions:</p>
<pre class="literal-block">
dataset = {data for line in aiter()
                async for data in line
                if check(data)}
</pre>
<p>Asynchronous comprehensions are only allowed inside an <tt class="docutils literal">async def</tt>
function.</p>
<p>In principle, asynchronous generator expressions are allowed in
any context.  However, in Python 3.6, due to <tt class="docutils literal">async</tt> and <tt class="docutils literal">await</tt>
soft-keyword status, asynchronous generator expressions are only
allowed in an <tt class="docutils literal">async def</tt> function.  Once <tt class="docutils literal">async</tt> and <tt class="docutils literal">await</tt>
become reserved keywords in Python 3.7, this restriction will be
removed.</p>
</div>
<div class="section" id="await-in-comprehensions">
<h2><a class="toc-backref" href="#id11"><tt class="docutils literal">await</tt> in Comprehensions</a></h2>
<p>We propose to allow the use of <tt class="docutils literal">await</tt> expressions in both
asynchronous and synchronous comprehensions:</p>
<pre class="literal-block">
result = [await fun() for fun in funcs]
result = {await fun() for fun in funcs}
result = {fun: await fun() for fun in funcs}

result = [await fun() for fun in funcs if await smth]
result = {await fun() for fun in funcs if await smth}
result = {fun: await fun() for fun in funcs if await smth}

result = [await fun() async for fun in funcs]
result = {await fun() async for fun in funcs}
result = {fun: await fun() async for fun in funcs}

result = [await fun() async for fun in funcs if await smth]
result = {await fun() async for fun in funcs if await smth}
result = {fun: await fun() async for fun in funcs if await smth}
</pre>
<p>This is only valid in <tt class="docutils literal">async def</tt> function body.</p>
</div>
<div class="section" id="grammar-updates">
<h2><a class="toc-backref" href="#id12">Grammar Updates</a></h2>
<p>The proposal requires one change on the grammar level: adding the
optional &quot;async&quot; keyword to <tt class="docutils literal">comp_for</tt>:</p>
<pre class="literal-block">
comp_for: [ASYNC] 'for' exprlist 'in' or_test [comp_iter]
</pre>
<p>The <tt class="docutils literal">comprehension</tt> AST node will have the new <tt class="docutils literal">is_async</tt> argument.</p>
</div>
<div class="section" id="backwards-compatibility">
<h2><a class="toc-backref" href="#id13">Backwards Compatibility</a></h2>
<p>The proposal is fully backwards compatible.</p>
</div>
</div>
<div class="section" id="acceptance">
<h1><a class="toc-backref" href="#id14">Acceptance</a></h1>
<p><a class="reference external" href="/dev/peps/pep-0530">PEP 530</a> was accepted by Guido, September 6, 2016 <a class="footnote-reference" href="#id4" id="id1">[1]</a>.</p>
</div>
<div class="section" id="implementation">
<h1><a class="toc-backref" href="#id15">Implementation</a></h1>
<p>The implementation is tracked in issue 28008 <a class="footnote-reference" href="#id6" id="id2">[3]</a>.  The reference
implementation git repository is available at <a class="footnote-reference" href="#id5" id="id3">[2]</a>.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id16">References</a></h1>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2016-September/042141.html">https://mail.python.org/pipermail/python-ideas/2016-September/042141.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td><a class="reference external" href="https://github.com/1st1/cpython/tree/asyncomp">https://github.com/1st1/cpython/tree/asyncomp</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[3]</a></td><td><a class="reference external" href="http://bugs.python.org/issue28008">http://bugs.python.org/issue28008</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="acknowledgments">
<h1><a class="toc-backref" href="#id17">Acknowledgments</a></h1>
<p>I thank Guido van Rossum, Victor Stinner and Elvis Pranskevichus
for their feedback, code reviews, and discussions around this
PEP.</p>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id18">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>


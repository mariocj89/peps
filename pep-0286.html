<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">286</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Enhanced Argument Tuples</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0286.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">martin&#32;&#97;t&#32;v.loewis.de (Martin von LÃ¶wis)</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Deferred</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">3-Mar-2002</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">2.3</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id5">Abstract</a></li>
<li><a class="reference internal" href="#pep-deferral" id="id6">PEP Deferral</a></li>
<li><a class="reference internal" href="#problem-description" id="id7">Problem description</a></li>
<li><a class="reference internal" href="#proposed-solution" id="id8">Proposed solution</a></li>
<li><a class="reference internal" href="#affected-converters" id="id9">Affected converters</a></li>
<li><a class="reference internal" href="#new-converters" id="id10">New converters</a></li>
<li><a class="reference internal" href="#references" id="id11">References</a></li>
<li><a class="reference internal" href="#copyright" id="id12">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id5">Abstract</a></h1>
<p><tt class="docutils literal">PyArg_ParseTuple</tt> is confronted with difficult memory management if
an argument converter creates new memory.  To deal with these
cases, a specialized argument type is proposed.</p>
</div>
<div class="section" id="pep-deferral">
<h1><a class="toc-backref" href="#id6">PEP Deferral</a></h1>
<p>Further exploration of the concepts covered in this PEP has been deferred
for lack of a current champion interested in promoting the goals of the
PEP and collecting and incorporating feedback, and with sufficient
available time to do so effectively.</p>
<p>The resolution of this PEP may also be affected by the resolution of
<a class="reference external" href="/dev/peps/pep-0426">PEP 426</a>, which proposes the use of a preprocessing step to generate
some aspects of C API interface code.</p>
</div>
<div class="section" id="problem-description">
<h1><a class="toc-backref" href="#id7">Problem description</a></h1>
<p>Today, argument tuples keep references to the function arguments,
which are guaranteed to live as long as the argument tuple exists
which is at least as long as the function call is being executed.</p>
<p>In some cases, parsing an argument will allocate new memory, which
is then to be released by the caller.  This has two problems:</p>
<ol class="arabic simple">
<li>In case of failure, the application cannot know what memory to
release; most callers don't even know that they have the
responsibility to release that memory.  Example for this are
the <tt class="docutils literal">N</tt> converter (bug #416288 <a class="footnote-reference" href="#id3" id="id1">[1]</a>) and the <tt class="docutils literal">es#</tt> converter (bug
#501716 <a class="footnote-reference" href="#id4" id="id2">[2]</a>).</li>
<li>Even for successful argument parsing, it is still inconvenient
for the caller to be responsible for releasing the memory.  In
some cases, this is unnecessarily inefficient.  For example,
the <tt class="docutils literal">es</tt> converter copies the conversion result into memory, even
though there already is a string object that has the right
contents.</li>
</ol>
</div>
<div class="section" id="proposed-solution">
<h1><a class="toc-backref" href="#id8">Proposed solution</a></h1>
<p>A new type 'argument tuple' is introduced.  This type derives from
tuple, adding an <tt class="docutils literal">__dict__</tt> member (at <tt class="docutils literal">tp_dictoffset</tt> -4).  Instances
of this type might get the following attributes:</p>
<ul class="simple">
<li>'failobjects', a list of objects which need to be deallocated
in case of success</li>
<li>'okobjects', a list of object which will be released when the
argument tuple is released</li>
</ul>
<p>To manage this type, the following functions will be added, and
used appropriately in <tt class="docutils literal">ceval.c</tt> and <tt class="docutils literal">getargs.c</tt>:</p>
<ul class="simple">
<li><tt class="docutils literal">PyArgTuple_New(int);</tt></li>
<li><tt class="docutils literal">PyArgTuple_AddFailObject(PyObject*, <span class="pre">PyObject*);</span></tt></li>
<li><tt class="docutils literal">PyArgTuple_AddFailMemory(PyObject*, <span class="pre">void*);</span></tt></li>
<li><tt class="docutils literal">PyArgTuple_AddOkObject(PyObject*, <span class="pre">PyObject*);</span></tt></li>
<li><tt class="docutils literal">PyArgTuple_AddOkMemory(PyObject*, <span class="pre">void*);</span></tt></li>
<li><tt class="docutils literal"><span class="pre">PyArgTuple_ClearFailed(PyObject*);</span></tt></li>
</ul>
<p>When argument parsing fails, all fail objects will be released
through <tt class="docutils literal">Py_DECREF</tt>, and all fail memory will be released through
<tt class="docutils literal">PyMem_Free</tt>.  If parsing succeeds, the references to the fail
objects and fail memory are dropped, without releasing anything.</p>
<p>When the argument tuple is released, all ok objects and memory
will be released.</p>
<p>If those functions are called with an object of a different type,
a warning is issued and no further action is taken; usage of the
affected converters without using argument tuples is deprecated.</p>
</div>
<div class="section" id="affected-converters">
<h1><a class="toc-backref" href="#id9">Affected converters</a></h1>
<p>The following converters will add fail memory and fail objects: <tt class="docutils literal">N</tt>,
<tt class="docutils literal">es</tt>, <tt class="docutils literal">et</tt>, <tt class="docutils literal">es#</tt>, <tt class="docutils literal">et#</tt> (unless memory is passed into the converter)</p>
</div>
<div class="section" id="new-converters">
<h1><a class="toc-backref" href="#id10">New converters</a></h1>
<p>To simplify Unicode conversion, the <tt class="docutils literal">e*</tt> converters are duplicated
as <tt class="docutils literal">E*</tt> converters (<tt class="docutils literal">Es</tt>, <tt class="docutils literal">Et</tt>, <tt class="docutils literal">Es#</tt>, <tt class="docutils literal">Et#</tt>).  The usage of the <tt class="docutils literal">E*</tt>
converters is identical to that of the <tt class="docutils literal">e*</tt> converters, except that
the application will not need to manage the resulting memory.
This will be implemented through registration of Ok objects with
the argument tuple.  The <tt class="docutils literal">e*</tt> converters are deprecated.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id11">References</a></h1>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>infrequent memory leak in pyexpat
(<a class="reference external" href="http://bugs.python.org/issue416288">http://bugs.python.org/issue416288</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>&quot;es#&quot; parser marker leaks memory
(<a class="reference external" href="http://bugs.python.org/issue501716">http://bugs.python.org/issue501716</a>)</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id12">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
fill-column: 70
End: -->
</div>


<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">528</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Change Windows console encoding to UTF-8</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0528.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Steve Dower &lt;steve.dower&#32;&#97;t&#32;python.org&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">27-Aug-2016</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.6</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">01-Sep-2016, 04-Sep-2016</td>
</tr>
<tr class="field"><th class="field-name">Resolution:</th><td class="field-body"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-September/146278.html">https://mail.python.org/pipermail/python-dev/2016-September/146278.html</a></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id5">Abstract</a></li>
<li><a class="reference internal" href="#specific-changes" id="id6">Specific Changes</a><ul>
<li><a class="reference internal" href="#add-io-windowsconsoleio" id="id7">Add _io.WindowsConsoleIO</a></li>
<li><a class="reference internal" href="#add-pyos-windowsconsolereadline" id="id8">Add _PyOS_WindowsConsoleReadline</a></li>
<li><a class="reference internal" href="#add-legacy-mode" id="id9">Add legacy mode</a></li>
</ul>
</li>
<li><a class="reference internal" href="#alternative-approaches" id="id10">Alternative Approaches</a></li>
<li><a class="reference internal" href="#code-that-may-break" id="id11">Code that may break</a><ul>
<li><a class="reference internal" href="#assuming-stdin-stdout-encoding" id="id12">Assuming stdin/stdout encoding</a></li>
<li><a class="reference internal" href="#incorrectly-using-the-raw-object" id="id13">Incorrectly using the raw object</a></li>
<li><a class="reference internal" href="#using-the-raw-object-with-small-buffers" id="id14">Using the raw object with small buffers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copyright" id="id15">Copyright</a></li>
<li><a class="reference internal" href="#references" id="id16">References</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id5">Abstract</a></h1>
<p>Historically, Python uses the ANSI APIs for interacting with the Windows
operating system, often via C Runtime functions. However, these have been long
discouraged in favor of the UTF-16 APIs. Within the operating system, all text
is represented as UTF-16, and the ANSI APIs perform encoding and decoding using
the active code page.</p>
<p>This PEP proposes changing the default standard stream implementation on Windows
to use the Unicode APIs. This will allow users to print and input the full range
of Unicode characters at the default Windows console. This also requires a
subtle change to how the tokenizer parses text from readline hooks.</p>
</div>
<div class="section" id="specific-changes">
<h1><a class="toc-backref" href="#id6">Specific Changes</a></h1>
<div class="section" id="add-io-windowsconsoleio">
<h2><a class="toc-backref" href="#id7">Add _io.WindowsConsoleIO</a></h2>
<p>Currently an instance of <tt class="docutils literal">_io.FileIO</tt> is used to wrap the file descriptors
representing standard input, output and error. We add a new class (implemented
in C) <tt class="docutils literal">_io.WindowsConsoleIO</tt> that acts as a raw IO object using the Windows
console functions, specifically, <tt class="docutils literal">ReadConsoleW</tt> and <tt class="docutils literal">WriteConsoleW</tt>.</p>
<p>This class will be used when the legacy-mode flag is not in effect, when opening
a standard stream by file descriptor and the stream is a console buffer rather
than a redirected file. Otherwise, <tt class="docutils literal">_io.FileIO</tt> will be used as it is today.</p>
<p>This is a raw (bytes) IO class that requires text to be passed encoded with
utf-8, which will be decoded to utf-16-le and passed to the Windows APIs.
Similarly, bytes read from the class will be provided by the operating system as
utf-16-le and converted into utf-8 when returned to Python.</p>
<p>The use of an ASCII compatible encoding is required to maintain compatibility
with code that bypasses the <tt class="docutils literal">TextIOWrapper</tt> and directly writes ASCII bytes to
the standard streams (for example, <a class="reference external" href="https://github.com/twisted/twisted/blob/trunk/src/twisted/test/process_stdinreader.py">Twisted's process_stdinreader.py</a> <a class="footnote-reference" href="#id1" id="id2">[1]</a>). Code that assumes
a particular encoding for the standard streams other than ASCII will likely
break.</p>
</div>
<div class="section" id="add-pyos-windowsconsolereadline">
<h2><a class="toc-backref" href="#id8">Add _PyOS_WindowsConsoleReadline</a></h2>
<p>To allow Unicode entry at the interactive prompt, a new readline hook is
required. The existing <tt class="docutils literal">PyOS_StdioReadline</tt> function will delegate to the new
<tt class="docutils literal">_PyOS_WindowsConsoleReadline</tt> function when reading from a file descriptor
that is a console buffer and the legacy-mode flag is not in effect (the logic
should be identical to above).</p>
<p>Since the readline interface is required to return an 8-bit encoded string with
no embedded nulls, the <tt class="docutils literal">_PyOS_WindowsConsoleReadline</tt> function transcodes from
utf-16-le as read from the operating system into utf-8.</p>
<p>The function <tt class="docutils literal">PyRun_InteractiveOneObject</tt> which currently obtains the encoding
from <tt class="docutils literal">sys.stdin</tt> will select utf-8 unless the legacy-mode flag is in effect.
This may require readline hooks to change their encodings to utf-8, or to
require legacy-mode for correct behaviour.</p>
</div>
<div class="section" id="add-legacy-mode">
<h2><a class="toc-backref" href="#id9">Add legacy mode</a></h2>
<p>Launching Python with the environment variable <tt class="docutils literal">PYTHONLEGACYWINDOWSSTDIO</tt> set
will enable the legacy-mode flag, which completely restores the previous
behaviour.</p>
</div>
</div>
<div class="section" id="alternative-approaches">
<h1><a class="toc-backref" href="#id10">Alternative Approaches</a></h1>
<p>The <a class="reference external" href="https://pypi.org/project/win_unicode_console/">win_unicode_console package</a> <a class="footnote-reference" href="#id3" id="id4">[2]</a> is a pure-Python alternative to changing the
default behaviour of the console. It implements essentially the same
modifications as described here using pure Python code.</p>
</div>
<div class="section" id="code-that-may-break">
<h1><a class="toc-backref" href="#id11">Code that may break</a></h1>
<p>The following code patterns may break or see different behaviour as a result of
this change. All of these code samples require explicitly choosing to use a raw
file object in place of a more convenient wrapper that would prevent any visible
change.</p>
<div class="section" id="assuming-stdin-stdout-encoding">
<h2><a class="toc-backref" href="#id12">Assuming stdin/stdout encoding</a></h2>
<p>Code that assumes that the encoding required by <tt class="docutils literal">sys.stdin.buffer</tt> or
<tt class="docutils literal">sys.stdout.buffer</tt> is <tt class="docutils literal">'mbcs'</tt> or a more specific encoding may currently be
working by chance, but could encounter issues under this change. For example:</p>
<pre class="literal-block">
&gt;&gt;&gt; sys.stdout.buffer.write(text.encode('mbcs'))
&gt;&gt;&gt; r = sys.stdin.buffer.read(16).decode('cp437')
</pre>
<p>To correct this code, the encoding specified on the <tt class="docutils literal">TextIOWrapper</tt> should be
used, either implicitly or explicitly:</p>
<pre class="literal-block">
&gt;&gt;&gt; # Fix 1: Use wrapper correctly
&gt;&gt;&gt; sys.stdout.write(text)
&gt;&gt;&gt; r = sys.stdin.read(16)

&gt;&gt;&gt; # Fix 2: Use encoding explicitly
&gt;&gt;&gt; sys.stdout.buffer.write(text.encode(sys.stdout.encoding))
&gt;&gt;&gt; r = sys.stdin.buffer.read(16).decode(sys.stdin.encoding)
</pre>
</div>
<div class="section" id="incorrectly-using-the-raw-object">
<h2><a class="toc-backref" href="#id13">Incorrectly using the raw object</a></h2>
<p>Code that uses the raw IO object and does not correctly handle partial reads and
writes may be affected. This is particularly important for reads, where the
number of characters read will never exceed one-fourth of the number of bytes
allowed, as there is no feasible way to prevent input from encoding as much
longer utf-8 strings:</p>
<pre class="literal-block">
&gt;&gt;&gt; raw_stdin = sys.stdin.buffer.raw
&gt;&gt;&gt; data = raw_stdin.read(15)
abcdefghijklm
b'abc'
# data contains at most 3 characters, and never more than 12 bytes
# error, as &quot;defghijklm\r\n&quot; is passed to the interactive prompt
</pre>
<p>To correct this code, the buffered reader/writer should be used, or the caller
should continue reading until its buffer is full:</p>
<pre class="literal-block">
&gt;&gt;&gt; # Fix 1: Use the buffered reader/writer
&gt;&gt;&gt; stdin = sys.stdin.buffer
&gt;&gt;&gt; data = stdin.read(15)
abcedfghijklm
b'abcdefghijklm\r\n'

&gt;&gt;&gt; # Fix 2: Loop until enough bytes have been read
&gt;&gt;&gt; raw_stdin = sys.stdin.buffer.raw
&gt;&gt;&gt; b = b''
&gt;&gt;&gt; while len(b) &lt; 15:
...     b += raw_stdin.read(15)
abcedfghijklm
b'abcdefghijklm\r\n'
</pre>
</div>
<div class="section" id="using-the-raw-object-with-small-buffers">
<h2><a class="toc-backref" href="#id14">Using the raw object with small buffers</a></h2>
<p>Code that uses the raw IO object and attempts to read less than four characters
will now receive an error. Because it's possible that any single character may
require up to four bytes when represented in utf-8, requests must fail:</p>
<pre class="literal-block">
&gt;&gt;&gt; raw_stdin = sys.stdin.buffer.raw
&gt;&gt;&gt; data = raw_stdin.read(3)
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
ValueError: must read at least 4 bytes
</pre>
<p>The only workaround is to pass a larger buffer:</p>
<pre class="literal-block">
&gt;&gt;&gt; # Fix: Request at least four bytes
&gt;&gt;&gt; raw_stdin = sys.stdin.buffer.raw
&gt;&gt;&gt; data = raw_stdin.read(4)
a
b'a'
&gt;&gt;&gt; &gt;&gt;&gt;
</pre>
<p>(The extra <tt class="docutils literal">&gt;&gt;&gt;</tt> is due to the newline remaining in the input buffer and is
expected in this situation.)</p>
</div>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id15">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id16">References</a></h1>
<table class="docutils footnote" frame="void" id="id1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="https://github.com/twisted/twisted/blob/trunk/src/twisted/test/process_stdinreader.py">https://github.com/twisted/twisted/blob/trunk/src/twisted/test/process_stdinreader.py</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td><a class="reference external" href="https://pypi.org/project/win_unicode_console/">https://pypi.org/project/win_unicode_console/</a></td></tr>
</tbody>
</table>
</div>


<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">500</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">A protocol for delegating datetime methods to their
tzinfo implementations</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0500.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Alexander Belopolsky &lt;alexander.belopolsky&#32;&#97;t&#32;gmail.com&gt;, Tim Peters &lt;tim.peters&#32;&#97;t&#32;gmail.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">Discussions-To:</th><td class="field-body">Datetime-SIG &lt;<a class="reference external" href="mailto:datetime-sig&#64;python.org?subject=PEP%20500">datetime-sig&#32;&#97;t&#32;python.org</a>&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Rejected</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Requires:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0495">495</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">08-Aug-2015</td>
</tr>
<tr class="field"><th class="field-name">Resolution:</th><td class="field-body"><a class="reference external" href="https://mail.python.org/pipermail/datetime-sig/2015-August/000354.html">https://mail.python.org/pipermail/datetime-sig/2015-August/000354.html</a></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id3">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id4">Rationale</a></li>
<li><a class="reference internal" href="#protocol" id="id5">Protocol</a><ul>
<li><a class="reference internal" href="#subtraction-of-datetime" id="id6">Subtraction of datetime</a></li>
<li><a class="reference internal" href="#addition" id="id7">Addition</a></li>
<li><a class="reference internal" href="#subtraction-of-timedelta" id="id8">Subtraction of timedelta</a></li>
<li><a class="reference internal" href="#formatting" id="id9">Formatting</a></li>
<li><a class="reference internal" href="#parsing" id="id10">Parsing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changes-to-datetime-methods" id="id11">Changes to datetime methods</a><ul>
<li><a class="reference internal" href="#subtraction" id="id12">Subtraction</a></li>
<li><a class="reference internal" href="#id1" id="id13">Addition</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strict-arithmetics" id="id14">Strict arithmetics</a><ul>
<li><a class="reference internal" href="#parsing-and-formatting" id="id15">Parsing and formatting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#applications" id="id16">Applications</a></li>
<li><a class="reference internal" href="#copyright" id="id17">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id3">Abstract</a></h1>
<p>This PEP specifies a new protocol (PDDM - &quot;A Protocol for Delegating
Datetime Methods&quot;) that can be used by concrete implementations of the
<tt class="docutils literal">datetime.tzinfo</tt> interface to override aware datetime arithmetics,
formatting and parsing.  We describe changes to the
<tt class="docutils literal">datetime.datetime</tt> class to support the new protocol and propose a
new abstract class <tt class="docutils literal">datetime.tzstrict</tt> that implements parts of this
protocol necessary to make aware datetime instances to follow &quot;strict&quot;
arithmetic rules.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id4">Rationale</a></h1>
<p>As of Python 3.5, aware datetime instances that share a <tt class="docutils literal">tzinfo</tt>
object follow the rules of arithmetics that are induced by a simple
bijection between (year, month, day, hour, minute, second,
microsecond) 7-tuples and large integers.  In this arithmetics, the
difference between YEAR-11-02T12:00 and YEAR-11-01T12:00 is always 24
hours, even though in the US/Eastern timezone, for example, there are
25 hours between 2014-11-01T12:00 and 2014-11-02T12:00 because the
local clocks were rolled back one hour at 2014-11-02T02:00,
introducing an extra hour in the night between 2014-11-01 and
2014-11-02.</p>
<p>Many business applications require the use of Python's simplified view
of local dates.  No self-respecting car rental company will charge its
customers more for a week that straddles the end of DST than for any
other week or require that they return the car an hour early.
Therefore, changing the current rules for aware datetime arithmetics
will not only create a backward compatibility nightmare, it will
eliminate support for legitimate and common use cases.</p>
<p>Since it is impossible to choose universal rules for local time
arithmetics, we propose to delegate implementation of those rules to
the classes that implement <tt class="docutils literal">datetime.tzinfo</tt> interface.  With such
delegation in place, users will be able to choose between different
arithmetics by simply picking instances of different classes for the
value of <tt class="docutils literal">tzinfo</tt>.</p>
</div>
<div class="section" id="protocol">
<h1><a class="toc-backref" href="#id5">Protocol</a></h1>
<div class="section" id="subtraction-of-datetime">
<h2><a class="toc-backref" href="#id6">Subtraction of datetime</a></h2>
<p>A <tt class="docutils literal">tzinfo</tt> subclass supporting the PDDM, may define a method called
<tt class="docutils literal">__datetime_diff__</tt> that should take two <tt class="docutils literal">datetime.datetime</tt>
instances and return a <tt class="docutils literal">datetime.timedelta</tt> instance representing
the time elapced from the time represented by the first datetime
instance to another.</p>
</div>
<div class="section" id="addition">
<h2><a class="toc-backref" href="#id7">Addition</a></h2>
<p>A <tt class="docutils literal">tzinfo</tt> subclass supporting the PDDM, may define a method called
<tt class="docutils literal">__datetime_add__</tt> that should take two arguments--a datetime and a
timedelta instances--and return a datetime instance.</p>
</div>
<div class="section" id="subtraction-of-timedelta">
<h2><a class="toc-backref" href="#id8">Subtraction of timedelta</a></h2>
<p>A <tt class="docutils literal">tzinfo</tt> subclass supporting the PDDM, may define a method called
<tt class="docutils literal">__datetime_sub__</tt> that should take two arguments--a datetime and a
timedelta instances--and return a datetime instance.</p>
</div>
<div class="section" id="formatting">
<h2><a class="toc-backref" href="#id9">Formatting</a></h2>
<p>A <tt class="docutils literal">tzinfo</tt> subclass supporting the PDDM, may define methods called
<tt class="docutils literal">__datetime_isoformat__</tt> and <tt class="docutils literal">__datetime_strftime__</tt>.</p>
<p>The <tt class="docutils literal">__datetime_isoformat__</tt> method should take a datetime instance
and an optional separator and produce a string representation of the
given datetime instance.</p>
<p>The <tt class="docutils literal">__datetime_strftime__</tt> method should take a datetime instance
and a format string and produce a string representation of the given
datetime instance formatted according to the given format.</p>
</div>
<div class="section" id="parsing">
<h2><a class="toc-backref" href="#id10">Parsing</a></h2>
<p>A <tt class="docutils literal">tzinfo</tt> subclass supporting the PDDM, may define a class method
called <tt class="docutils literal">__datetime_strptime__</tt> and register the &quot;canonical&quot; names of
the timezones that it implements with a registry. <strong>TODO</strong> Describe a
registry.</p>
</div>
</div>
<div class="section" id="changes-to-datetime-methods">
<h1><a class="toc-backref" href="#id11">Changes to datetime methods</a></h1>
<div class="section" id="subtraction">
<h2><a class="toc-backref" href="#id12">Subtraction</a></h2>
<pre class="literal-block">
class datetime:
    def __sub__(self, other):
        if isinstance(other, datetime):
            try:
                self_diff = self.tzinfo.__datetime_diff__
            except AttributeError:
                self_diff = None
            try:
                other_diff = self.tzinfo.__datetime_diff__
            except AttributeError:
                other_diff = None
            if self_diff is not None:
                if self_diff is not other_diff and self_diff.__func__ is not other_diff.__func__:
                    raise ValueError(&quot;Cannot find difference of two datetimes with &quot;
                                     &quot;different tzinfo.__datetime_diff__ implementations.&quot;)
                return self_diff(self, other)
        elif isinstance(other, timedelta):
            try:
                sub = self.tzinfo.__datetime_sub__
            except AttributeError:
                pass
            else:
                return sub(self, other)
            return self + -other
        else:
            return NotImplemented
        # current implementation
</pre>
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id13">Addition</a></h2>
<p>Addition of a timedelta to a datetime instance will be delegated to the
<tt class="docutils literal">self.tzinfo.__datetime_add__</tt> method whenever it is defined.</p>
</div>
</div>
<div class="section" id="strict-arithmetics">
<h1><a class="toc-backref" href="#id14">Strict arithmetics</a></h1>
<p>A new abstract subclass of <tt class="docutils literal">datetime.tzinfo</tt> class called  <tt class="docutils literal">datetime.tzstrict</tt>
will be added to the <tt class="docutils literal">datetime</tt> module.  This subclass will not implement the
<tt class="docutils literal">utcoffset()</tt>, <tt class="docutils literal">tzname()</tt> or <tt class="docutils literal">dst()</tt> methods, but will implement some of the
methods of the PDDM.</p>
<p>The PDDM methods implemented by <tt class="docutils literal">tzstrict</tt> will be equivalent to the following:</p>
<pre class="literal-block">
class tzstrict(tzinfo):
    def __datetime_diff__(self, dt1, dt2):
        utc_dt1 = dt1.astimezone(timezone.utc)
        utc_dt2 = dt2.astimezone(timezone.utc)
        return utc_dt2 - utc_dt1

    def __datetime_add__(self, dt, delta):
        utc_dt = dt.astimezone(timezone.utc)
        return (utc_dt + delta).astimezone(self)

    def __datetime_sub__(self, dt, delta):
        utc_dt = dt.astimezone(timezone.utc)
        return (utc_dt - delta).astimezone(self)
</pre>
<div class="section" id="parsing-and-formatting">
<h2><a class="toc-backref" href="#id15">Parsing and formatting</a></h2>
<p>Datetime methods <tt class="docutils literal">strftime</tt> and <tt class="docutils literal">isoformat</tt> will delegate to the namesake
methods of their <tt class="docutils literal">tzinfo</tt> members whenever those methods are defined.</p>
<p>When the <tt class="docutils literal">datetime.strptime</tt> method is given a format string that
contains a <tt class="docutils literal">%Z</tt> instruction, it will lookup the <tt class="docutils literal">tzinfo</tt>
implementation in the registry by the given timezone name and call its
<tt class="docutils literal">__datetime_strptime__</tt> method.</p>
</div>
</div>
<div class="section" id="applications">
<h1><a class="toc-backref" href="#id16">Applications</a></h1>
<p>This PEP will enable third party implementation of many different
timekeeping schemes including:</p>
<ul class="simple">
<li>Julian / Microsoft Excel calendar.</li>
<li>&quot;Right&quot; timezones with the leap second support.</li>
<li>French revolutionary calendar (with a lot of work).</li>
</ul>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id17">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
</div>


<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">397</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Python launcher for Windows</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">a57419aee37d</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0397.txt">2012/06/19 15:13:49</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Mark Hammond &lt;mhammond&#32;&#97;t&#32;skippinet.com.au&gt;,
Martin v. LÃ¶wis &lt;martin&#32;&#97;t&#32;v.loewis.de&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Final</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">15-Mar-2011</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">21-July-2011, 17-May-2011, 15-Mar-2011</td>
</tr>
<tr class="field"><th class="field-name">Resolution:</th><td class="field-body"><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2012-June/120505.html">https://mail.python.org/pipermail/python-dev/2012-June/120505.html</a></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id11">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id12">Rationale</a></li>
<li><a class="reference internal" href="#specification" id="id13">Specification</a><ul>
<li><a class="reference internal" href="#installation" id="id14">Installation</a></li>
<li><a class="reference internal" href="#python-script-launching" id="id15">Python Script Launching</a></li>
<li><a class="reference internal" href="#shebang-line-parsing" id="id16">Shebang line parsing</a></li>
<li><a class="reference internal" href="#configuration-file" id="id17">Configuration file</a></li>
<li><a class="reference internal" href="#virtual-commands-in-shebang-lines" id="id18">Virtual commands in shebang lines</a></li>
<li><a class="reference internal" href="#customized-commands" id="id19">Customized Commands</a></li>
<li><a class="reference internal" href="#python-version-qualifiers" id="id20">Python Version Qualifiers</a></li>
<li><a class="reference internal" href="#command-line-handling" id="id21">Command-line handling</a></li>
<li><a class="reference internal" href="#process-launching" id="id22">Process Launching</a></li>
</ul>
</li>
<li><a class="reference internal" href="#discussion" id="id23">Discussion</a></li>
<li><a class="reference internal" href="#references" id="id24">References</a></li>
<li><a class="reference internal" href="#copyright" id="id25">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id11">Abstract</a></h1>
<p>This PEP describes a Python launcher for the Windows platform.  A
Python launcher is a single executable which uses a number of
heuristics to locate a Python executable and launch it with a
specified command line.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id12">Rationale</a></h1>
<p>Windows provides &quot;file associations&quot; so an executable can be associated
with an extension, allowing for scripts to be executed directly in some
contexts (eg., double-clicking the file in Windows Explorer.)  Until now,
a strategy of &quot;last installed Python wins&quot; has been used and while not
ideal, has generally been workable due to the conservative changes in
Python 2.x releases.  As Python 3.x scripts are often syntactically
incompatible with Python 2.x scripts, a different strategy must be used
to allow files with a '.py' extension to use a different executable based
on the Python version the script targets.  This will be done by borrowing
the existing practices of another operating system - scripts will be able
to nominate the version of Python they need by way of a &quot;shebang&quot; line, as
described below.</p>
<p>Unix-like operating systems (referred to simply as &quot;Unix&quot; in this
PEP) allow scripts to be executed as if they were executable images
by examining the script for a &quot;shebang&quot; line which specifies the
actual executable to be used to run the script.  This is described in
detail in the <tt class="docutils literal">evecve(2)</tt> man page <a class="footnote-reference" href="#id7" id="id1">[1]</a> and while user documentation will
be created for this feature, for the purposes of this PEP that man
page describes a valid shebang line.</p>
<p>Additionally, these operating systems provide symbolic-links to
Python executables in well-known directories.  For example, many
systems will have a link /usr/bin/python which references a
particular version of Python installed under the operating-system.
These symbolic links allow Python to be executed without regard for
where Python it actually installed on the machine (eg., without
requiring the path where Python is actually installed to be
referenced in the shebang line or in the <tt class="docutils literal">PATH</tt>.)  <a class="reference external" href="/dev/peps/pep-0394">PEP 394</a> 'The &quot;python&quot;
command on Unix-Like Systems' <a class="footnote-reference" href="#id8" id="id2">[2]</a> describes additional conventions
for more fine-grained specification of a particular Python version.</p>
<p>These 2 facilities combined allow for a portable and somewhat
predictable way of both starting Python interactively and for allowing
Python scripts to execute.  This PEP describes an implementation of a
launcher which can offer the same benefits for Python on the Windows
platform and therefore allows the launcher to be the executable
associated with '.py' files to support multiple Python versions
concurrently.</p>
<p>While this PEP offers the ability to use a shebang line which should
work on both Windows and Unix, this is not the primary motivation for
this PEP - the primary motivation is to allow a specific version to be
specified without inventing new syntax or conventions to describe
it.</p>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id13">Specification</a></h1>
<p>This PEP specifies features of the launcher; a prototype
implementation is provided in <a class="footnote-reference" href="#id9" id="id3">[3]</a> which will be distributed
together with the Windows installer of Python, but will also be
available separately (but released along with the Python
installer). New features may be added to the launcher as
long as the features prescribed here continue to work.</p>
<div class="section" id="installation">
<h2><a class="toc-backref" href="#id14">Installation</a></h2>
<p>The launcher comes in 2 versions - one which is a console program and
one which is a &quot;windows&quot; (ie., GUI) program.  These 2 launchers correspond
to the 'python.exe' and 'pythonw.exe' executables which currently ship
with Python.  The console launcher will be named 'py.exe' and the Windows
one named 'pyw.exe'.  The &quot;windows&quot; (ie., GUI) version of the launcher
will attempt to locate and launch pythonw.exe even if a virtual shebang
line nominates simply &quot;python&quot; - in fact, the trailing 'w' notation is
not supported in the virtual shebang line at all.</p>
<p>The launcher is installed into the Windows directory (see
discussion below) if installed by a privileged user. The
stand-alone installer asks for an alternative location of the
installer, and adds that location to the user's <tt class="docutils literal">PATH</tt>.</p>
<p>The installation in the Windows directory is a 32-bit executable
(see discussion); the standalone installer may also offer to install
64-bit versions of the launcher.</p>
<p>The launcher installation is registered in
<tt class="docutils literal">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\CurrentVersion\SharedDLLs</tt>
with a reference counter.
It contains a version resource matching the version number of the
pythonXY.dll with which it is distributed. Independent
installations will overwrite older version
of the launcher with newer versions. Stand-alone releases use
a release level of <tt class="docutils literal">0x10</tt> in <tt class="docutils literal">FIELD3</tt> of the CPython release on which
they are based.</p>
<p>Once installed, the &quot;console&quot; version of the launcher is
associated with .py files and the &quot;windows&quot; version associated with .pyw
files.</p>
<p>The launcher is not tied to a specific version of Python - eg., a
launcher distributed with Python 3.3 should be capable of locating and
executing any Python 2.x and Python 3.x version. However, the
launcher binaries have a version resource that is the same as the
version resource in the Python binaries that they are released with.</p>
</div>
<div class="section" id="python-script-launching">
<h2><a class="toc-backref" href="#id15">Python Script Launching</a></h2>
<p>The launcher is restricted to launching Python scripts.
It is not intended as a general-purpose script launcher or
shebang processor.</p>
<p>The launcher supports the syntax of shebang lines as described
in <a class="footnote-reference" href="#id7" id="id4">[1]</a>, including all restrictions listed.</p>
<p>The launcher supports shebang lines referring to Python
executables with any of the (regex) prefixes &quot;/usr/bin/&quot;, &quot;/usr/local/bin&quot;
and &quot;/usr/bin/env *&quot;, as well as binaries specified without</p>
<p>For example, a shebang line of '#! /usr/bin/python' should work even
though there is unlikely to be an executable in the relative Windows
directory &quot;\usr\bin&quot;.  This means that many scripts can use a single
shebang line and be likely to work on both Unix and Windows without
modification.</p>
<p>The launcher will support fully-qualified paths to executables.
While this will make the script inherently non-portable, it is a
feature offered by Unix and would be useful for Windows users in
some cases.</p>
<p>The launcher will be capable of supporting implementations other than
CPython, such as jython and IronPython, but given both the absence of
common links on Unix (such as &quot;/usr/bin/jython&quot;) and the inability for the
launcher to automatically locate the installation location of these
implementations on Windows, the launcher will support this via
customization options.  Scripts taking advantage of this will not be
portable (as these customization options must be set to reflect the
configuration of the machine on which the launcher is running) but this
ability is nonetheless considered worthwhile.</p>
<p>On Unix, the user can control which specific version of Python is used
by adjusting the links in /usr/bin to point to the desired version.  As
the launcher on Windows will not use Windows links, cutomization options
(exposed via both environment variables and INI files) will be used to
override the semantics for determining what version of Python will be
used.  For example, while a shebang line of &quot;/usr/bin/python2&quot; will
automatically locate a Python 2.x implementation, an environment variable
can override exactly which Python 2.x implementation will be chosen.
Similarly for &quot;/usr/bin/python&quot; and &quot;/usr/bin/python3&quot;.  This is
specified in detail later in this PEP.</p>
</div>
<div class="section" id="shebang-line-parsing">
<h2><a class="toc-backref" href="#id16">Shebang line parsing</a></h2>
<p>If the first command-line argument does not start with a dash ('-')
character, an attempt will be made to open that argument as a file
and parsed for a shebang line according to the rules in <a class="footnote-reference" href="#id7" id="id5">[1]</a>:</p>
<pre class="literal-block">
#! interpreter [optional-arg]
</pre>
<p>Once parsed, the command will be categorized according to the following rules:</p>
<ul class="simple">
<li>If the command starts with the definition of a customized command
followed by a whitespace character (including a newline), the customized
command will be used.  See below for a description of customized
commands.</li>
<li>The launcher will define a set of prefixes which are considered Unix
compatible commands to launch Python, namely &quot;/usr/bin/python&quot;,
&quot;/usr/local/bin/python&quot;, &quot;/usr/bin/env python&quot;, and &quot;python&quot;.
If a command starts with one of these strings will be treated as a
'virtual command' and the rules described in Python Version Qualifiers
(below) will be used to locate the executable to use.</li>
<li>Otherwise the command is assumed to be directly ready to execute - ie.
a fully-qualified path (or a reference to an executable on the <tt class="docutils literal">PATH</tt>)
optionally followed by arguments.  The contents of the string will not
be parsed - it will be passed directly to the Windows CreateProcess
function after appending the name of the script and the launcher
command-line arguments.  This means that the rules used by
CreateProcess will be used, including how relative path names and
executable references without extensions are treated.  Notably, the
Windows command processor will not be used, so special rules used by the
command processor (such as automatic appending of extensions other than
'.exe', support for batch files, etc) will not be used.</li>
</ul>
<p>The use of 'virtual' shebang lines is encouraged as this should
allow for portable shebang lines to be specified which work on
multiple operating systems and different installations of the same
operating system.</p>
<p>If the first argument can not be opened as a file or if no valid
shebang line can be found, the launcher will act as if a shebang line of
'#!python' was found - ie., a default Python interpreter will be
located and the arguments passed to that.  However, if a valid
shebang line is found but the process specified by that line can not
be started, the default interpreter will not be started - the error
to create the specified child process will cause the launcher to display
an appropriate message and terminate with a specific exit code.</p>
</div>
<div class="section" id="configuration-file">
<h2><a class="toc-backref" href="#id17">Configuration file</a></h2>
<p>Two .ini files will be searched by the launcher - <tt class="docutils literal">py.ini</tt> in the
current user's &quot;application data&quot; directory (i.e. the directory returned
by calling the Windows function <tt class="docutils literal">SHGetFolderPath</tt> with <tt class="docutils literal">CSIDL_LOCAL_APPDATA</tt>,
<tt class="docutils literal"><span class="pre">%USERPROFILE%\AppData\Local</span></tt> on Vista+,
<tt class="docutils literal"><span class="pre">%USERPROFILE%\Local</span> Settings\Application Data</tt> on XP)
and <tt class="docutils literal">py.ini</tt> in the same directory as the launcher.  The same .ini
files are used for both the 'console' version of the launcher (i.e.
py.exe) and for the 'windows' version (i.e. pyw.exe)</p>
<p>Customization specified in the &quot;application directory&quot; will have
precedence over the one next to the executable, so a user, who may not
have write access to the .ini file next to the launcher, can override
commands in that global .ini file)</p>
</div>
<div class="section" id="virtual-commands-in-shebang-lines">
<h2><a class="toc-backref" href="#id18">Virtual commands in shebang lines</a></h2>
<p>Virtual Commands are shebang lines which start with strings which would
be expected to work on Unix platforms - examples include
'/usr/bin/python', '/usr/bin/env python' and 'python'.  Optionally, the
virtual command may be suffixed with a version qualifier (see below),
such as '/usr/bin/python2' or '/usr/bin/python3.2'.  The command executed
is based on the rules described in Python Version Qualifiers
below.</p>
</div>
<div class="section" id="customized-commands">
<h2><a class="toc-backref" href="#id19">Customized Commands</a></h2>
<p>The launcher will support the ability to define &quot;Customized Commands&quot; in a
Windows .ini file (ie, a file which can be parsed by the Windows function
GetPrivateProfileString).  A section called '[commands]' can be created
with key names defining the virtual command and the value specifying the
actual command-line to be used for this virtual command.</p>
<p>For example, if an INI file has the contents:</p>
<pre class="literal-block">
[commands]
vpython=c:\bin\vpython.exe -foo
</pre>
<p>Then a shebang line of '#! vpython' in a script named 'doit.py' will
result in the launcher using the command-line
<tt class="docutils literal"><span class="pre">c:\bin\vpython.exe</span> <span class="pre">-foo</span> doit.py</tt></p>
<p>The precise details about the names, locations and search order of the
.ini files is in the launcher documentation <a class="footnote-reference" href="#id10" id="id6">[4]</a></p>
</div>
<div class="section" id="python-version-qualifiers">
<h2><a class="toc-backref" href="#id20">Python Version Qualifiers</a></h2>
<p>Some of the features described allow an optional Python version qualifier
to be used.</p>
<p>A version qualifier starts with a major version number and can optionally
be followed by a period ('.') and a minor version specifier.  If the minor
qualifier is specified, it may optionally be followed by &quot;-32&quot; to indicate
the 32bit implementation of that version be used.  Note that no &quot;-64&quot;
qualifier is necessary as this is the default implementation (see below).</p>
<p>On 64bit Windows with both 32bit and 64bit implementations of the
same (major.minor) Python version installed, the 64bit version will
always be preferred.  This will be true for both 32bit and 64bit
implementations of the launcher - a 32bit launcher will prefer to
execute a 64bit Python installation of the specified version if
available.  This is so the behavior of the launcher can be predicted
knowing only what versions are installed on the PC and without
regard to the order in which they were installed (ie, without knowing
whether a 32 or 64bit version of Python and corresponding launcher was
installed last).  As noted above, an optional &quot;-32&quot; suffix can be used
on a version specifier to change this behaviour.</p>
<p>If no version qualifiers are found in a command, the environment variable
<tt class="docutils literal">PY_PYTHON</tt> can be set to specify the default version qualifier - the default
value is &quot;2&quot;. Note this value could specify just a major version (e.g. &quot;2&quot;) or
a major.minor qualifier (e.g. &quot;2.6&quot;), or even major.minor-32.</p>
<p>If no minor version qualifiers are found, the environment variable
<tt class="docutils literal">PY_PYTHON{major}</tt> (where <tt class="docutils literal">{major}</tt> is the current major version qualifier
as determined above) can be set to specify the full version. If no such option
is found, the launcher will enumerate the installed Python versions and use
the latest minor release found for the major version, which is likely,
although not guaranteed, to be the most recently installed version in that
family.</p>
<p>In addition to environment variables, the same settings can be configured
in the .INI file used by the launcher.  The section in the INI file is
called <tt class="docutils literal">[defaults]</tt> and the key name will be the same as the
environment variables without the leading <tt class="docutils literal">PY_</tt> prefix (and note that
the key names in the INI file are case insensitive.)  The contents of
an environment variable will override things specified in the INI file.</p>
</div>
<div class="section" id="command-line-handling">
<h2><a class="toc-backref" href="#id21">Command-line handling</a></h2>
<p>Only the first command-line argument will be checked for a shebang line
and only if that argument does not start with a '-'.</p>
<p>If the only command-line argument is &quot;-h&quot; or &quot;--help&quot;, the launcher will
print a small banner and command-line usage, then pass the argument to
the default Python.  This will cause help for the launcher being printed
followed by help for Python itself.  The output from the launcher will
clearly indicate the extended help information is coming from the
launcher and not Python.</p>
<p>As a concession to interactively launching Python, the launcher will
support the first command-line argument optionally being a dash (&quot;-&quot;)
followed by a version qualifier, as described above, to nominate a
specific version be used.  For example, while &quot;py.exe&quot; may locate and
launch the latest Python 2.x implementation installed, a command-line such
as &quot;py.exe -3&quot; could specify the latest Python 3.x implementation be
launched, while &quot;py.exe -2.6-32&quot; could specify a 32bit implementation
Python 2.6 be located and launched.  If a Python 2.x implementation is
desired to be launched with the -3 flag, the command-line would need to be
similar to &quot;py.exe -2 -3&quot; (or the specific version of Python could
obviously be launched manually without use of this launcher.)  Note that
this feature can not be used with shebang processing as the file scanned
for a shebang line and this argument must both be the first argument and
therefore are mutually exclusive.</p>
<p>All other arguments will be passed untouched to the child Python process.</p>
</div>
<div class="section" id="process-launching">
<h2><a class="toc-backref" href="#id22">Process Launching</a></h2>
<p>The launcher offers some conveniences for Python developers working
interactively - for example, starting the launcher with no command-line
arguments will launch the default Python with no command-line arguments.
Further, command-line arguments will be supported to allow a specific
Python version to be launched interactively - however, these conveniences
must not detract from the primary purpose of launching scripts and must
be easy to avoid if desired.</p>
<p>The launcher creates a subprocess to start the actual
interpreter. See <strong>Discussion</strong> below for the rationale.</p>
</div>
</div>
<div class="section" id="discussion">
<h1><a class="toc-backref" href="#id23">Discussion</a></h1>
<p>It may be surprising that the launcher is installed into the
Windows directory, and not the System32 directory. The reason is
that the System32 directory is not on the Path of a 32-bit process
running on a 64-bit system. However, the Windows directory is
always on the path.</p>
<p>The launcher that is installed into the Windows directory is a 32-bit
executable so that the 32-bit CPython installer can provide the same
binary for both 32-bit and 64-bit Windows installations.</p>
<p>Ideally, the launcher process would execute Python directly inside
the same process, primarily so the parent of the launcher process could
terminate the launcher and have the Python interpreter terminate.  If the
launcher executes Python as a sub-process and the parent of the launcher
terminates the launcher, the Python process will be unaffected.</p>
<p>However, there are a number of practical problems associated with this
approach.  Windows does not support the <tt class="docutils literal">execv*</tt> family of Unix functions,
so this could only be done by the launcher dynamically loading the Python
DLL, but this would have a number of side-effects.  The most serious
side effect of this is that the value of sys.executable would refer to the
launcher instead of the Python implementation.  Many Python scripts use the
value of <tt class="docutils literal">sys.executable</tt> to launch child processes, and these scripts may
fail to work as expected if the launcher is used.  Consider a &quot;parent&quot;
script with a shebang line of '#! /usr/bin/python3' which attempts to
launch a child script (with no shebang) via <tt class="docutils literal">sys.executable</tt> - currently the
child is launched using the exact same version running the parent script.
If <tt class="docutils literal">sys.executable</tt> referred to the launcher the child would be likely
executed using a Python 2.x version and would be likely to fail with a
<tt class="docutils literal">SyntaxError</tt>.</p>
<p>Another hurdle is the support for alternative Python implementations
using the &quot;customized commands&quot; feature described above, where loading
the command dynamically into a running executable is not possible.</p>
<p>The final hurdle is the rules above regarding 64bit and 32bit programs -
a 32bit launcher would be unable to load the 64bit version of Python and
vice-versa.</p>
<p>Given these considerations, the launcher will execute its command in a
child process, remaining alive while the child process is executing, then
terminate with the same exit code as returned by the child.  To address
concerns regarding the termination of the launcher not killing the child,
the Win32 Job API will be used to arrange so that the child process is
automatically killed when the parent is terminated (although children of
that child process will continue as is the case now.)  As this Windows API
is available in Windows XP and later, this launcher will not work on
Windows 2000 or earlier.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id24">References</a></h1>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id4">2</a>, <a class="fn-backref" href="#id5">3</a>)</em> <a class="reference external" href="http://linux.die.net/man/2/execve">http://linux.die.net/man/2/execve</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://www.python.org/dev/peps/pep-0394/">http://www.python.org/dev/peps/pep-0394/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://bitbucket.org/vinay.sajip/pylauncher">https://bitbucket.org/vinay.sajip/pylauncher</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[4]</a></td><td><a class="reference external" href="https://bitbucket.org/vinay.sajip/pylauncher/src/tip/Doc/launcher.rst">https://bitbucket.org/vinay.sajip/pylauncher/src/tip/Doc/launcher.rst</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id25">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>


<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">536</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Final Grammar for Literal String Interpolation</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">$Revision$</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="https://hg.python.org/peps/file/tip/pep-0536.txt">$Date$</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Philipp Angerer &lt;phil.angerer&#32;&#97;t&#32;gmail.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">11-Dec-2016</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">3.7</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">12-Dec-2016</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id5">Abstract</a></li>
<li><a class="reference internal" href="#terminology" id="id6">Terminology</a></li>
<li><a class="reference internal" href="#motivation" id="id7">Motivation</a></li>
<li><a class="reference internal" href="#rationale" id="id8">Rationale</a></li>
<li><a class="reference internal" href="#specification" id="id9">Specification</a></li>
<li><a class="reference internal" href="#backwards-compatibility" id="id10">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#reference-implementation" id="id11">Reference Implementation</a></li>
<li><a class="reference internal" href="#references" id="id12">References</a></li>
<li><a class="reference internal" href="#copyright" id="id13">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id5">Abstract</a></h1>
<p><a class="reference external" href="/dev/peps/pep-0498">PEP 498</a> introduced Literal String Interpolation (or “f-strings”).
The expression portions of those literals however are subject to
certain restrictions.  This PEP proposes a formal grammar lifting
those restrictions, promoting “f-strings” to “f expressions” or f-literals.</p>
<p>This PEP expands upon the f-strings introduced by <a class="reference external" href="/dev/peps/pep-0498">PEP 498</a>,
so this text requires familiarity with <a class="reference external" href="/dev/peps/pep-0498">PEP 498</a>.</p>
</div>
<div class="section" id="terminology">
<h1><a class="toc-backref" href="#id6">Terminology</a></h1>
<p>This text will refer to the existing grammar as “f-strings”,
and the proposed one as “f-literals”.</p>
<p>Furthermore, it will refer to the <tt class="docutils literal">{}</tt>-delimited expressions in
f-literals/f-strings as “expression portions” and the static string content
around them as “string portions”.</p>
</div>
<div class="section" id="motivation">
<h1><a class="toc-backref" href="#id7">Motivation</a></h1>
<p>The current implementation of f-strings in CPython relies on the existing
string parsing machinery and a post processing of its tokens.  This results in
several restrictions to the possible expressions usable within f-strings:</p>
<ol class="arabic">
<li><p class="first">It is impossible to use the quote character delimiting the f-string
within the expression portion:</p>
<pre class="literal-block">
&gt;&gt;&gt; f'Magic wand: { bag['wand'] }'
                             ^
SyntaxError: invalid syntax
</pre>
</li>
<li><p class="first">A previously considered way around it would lead to escape sequences
in executed code and is prohibited in f-strings:</p>
<pre class="literal-block">
&gt;&gt;&gt; f'Magic wand { bag[\'wand\'] } string'
SyntaxError: f-string expression portion cannot include a backslash
</pre>
</li>
<li><p class="first">Comments are forbidden even in multi-line f-strings:</p>
<pre class="literal-block">
&gt;&gt;&gt; f'''A complex trick: {
... bag['bag']  # recursive bags!
... }'''
SyntaxError: f-string expression part cannot include '#'
</pre>
</li>
<li><p class="first">Expression portions need to wrap <tt class="docutils literal">':'</tt> and <tt class="docutils literal">'!'</tt> in braces:</p>
<pre class="literal-block">
&gt;&gt;&gt; f'Useless use of lambdas: { lambda x: x*2 }'
SyntaxError: unexpected EOF while parsing
</pre>
</li>
</ol>
<p>These limitations serve no purpose from a language user perspective and
can be lifted by giving f-literals a regular grammar without exceptions
and implementing it using dedicated parse code.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id8">Rationale</a></h1>
<!-- https://mail.python.org/pipermail/python-ideas/2016-August/041727.html -->
<p>The restrictions mentioned in <a class="reference internal" href="#motivation">Motivation</a> are non-obvious and counter-intuitive
unless the user is familiar with the f-literals’ implementation details.</p>
<p>As mentioned, a previous version of <a class="reference external" href="/dev/peps/pep-0498">PEP 498</a> allowed escape sequences
anywhere in f-strings, including as ways to encode the braces delimiting
the expression portions and in their code.  They would be expanded before
the code is parsed, which would have had several important ramifications:</p>
<p>#. It would not be clear to human readers which portions are Expressions
and which are strings.  Great material for an “obfuscated/underhanded
Python challenge”
#. Syntax highlighters are good in parsing nested grammar, but not
in recognizing escape sequences.  ECMAScript 2016 (JavaScript) allows
escape sequences in its identifiers <a class="footnote-reference" href="#id3" id="id1">[1]</a> and the author knows of no
syntax highlighter able to correctly highlight code making use of this.</p>
<p>As a consequence, the expression portions would be harder to recognize
with and without the aid of syntax highlighting.  With the new grammar,
it is easy to extend syntax highlighters to correctly parse
and display f-literals:</p>
<pre><span style=color:#ff5500>f'Magic wand: </span><span style=color:#3daee9>{</span>bag[<span style=color:#bf0303>'wand'</span>]<span style=color:#3daee9>:^10}</span><span style=color:#ff5500>'</span></pre><!-- This is the output of kate-syntax-highlighter when given that code
(with some quotes stripped) -->
<p>Highlighting expression portions with possible escape sequences would
mean to create a modified copy of all rules of the complete expression
grammar, accounting for the possibility of escape sequences in key words,
delimiters, and all other language syntax. One such duplication would
yield one level of escaping depth and have to be repeated for a deeper
escaping in a recursive f-literal. This is the case since no highlighting
engine known to the author supports expanding escape sequences before
applying rules to a certain context. Nesting contexts however is a
standard feature of all highlighting engines.</p>
<p>Familiarity also plays a role: Arbitrary nesting of expressions
without expansion of escape sequences is available in every single
other language employing a string interpolation method that uses
expressions instead of just variable names. <a class="footnote-reference" href="#id4" id="id2">[2]</a></p>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id9">Specification</a></h1>
<p><a class="reference external" href="/dev/peps/pep-0498">PEP 498</a> specified f-strings as the following, but places restrictions on it:</p>
<pre class="literal-block">
f ' &lt;text&gt; { &lt;expression&gt; &lt;optional !s, !r, or !a&gt; &lt;optional : format specifier&gt; } &lt;text&gt; ... '
</pre>
<p>All restrictions mentioned in the PEP are lifted from f-literals,
as explained below:</p>
<ol class="arabic simple">
<li>Expression portions may now contain strings delimited with the same
kind of quote that is used to delimit the f-literal.</li>
<li>Backslashes may now appear within expressions just like anywhere else
in Python code.  In case of strings nested within f-literals,
escape sequences are expanded when the innermost string is evaluated.</li>
<li>Comments, using the <tt class="docutils literal">'#'</tt> character, are possible only in multi-line
f-literals, since comments are terminated by the end of the line
(which makes closing a single-line f-literal impossible).</li>
<li>Expression portions may contain <tt class="docutils literal">':'</tt> or <tt class="docutils literal">'!'</tt> wherever
syntactically valid.  The first <tt class="docutils literal">':'</tt> or <tt class="docutils literal">'!'</tt> that is not part
of an expression has to be followed a valid coercion or format specifier.</li>
</ol>
<p>A remaining restriction not explicitly mentioned by <a class="reference external" href="/dev/peps/pep-0498">PEP 498</a> is line breaks
in expression portions.  Since strings delimited by single <tt class="docutils literal">'</tt> or <tt class="docutils literal">&quot;</tt>
characters are expected to be single line, line breaks remain illegal
in expression portions of single line strings.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Is lifting of the restrictions sufficient,
or should we specify a more complete grammar?</p>
</div>
</div>
<div class="section" id="backwards-compatibility">
<h1><a class="toc-backref" href="#id10">Backwards Compatibility</a></h1>
<p>f-literals are fully backwards compatible to f-strings,
and expands the syntax considered legal.</p>
</div>
<div class="section" id="reference-implementation">
<h1><a class="toc-backref" href="#id11">Reference Implementation</a></h1>
<p>TBD</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id12">References</a></h1>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><p class="first">ECMAScript <tt class="docutils literal">IdentifierName</tt> specification
( <a class="reference external" href="http://ecma-international.org/ecma-262/6.0/#sec-names-and-keywords">http://ecma-international.org/ecma-262/6.0/#sec-names-and-keywords</a> )</p>
<p class="last">Yes, <tt class="docutils literal">const cthulhu = { <span class="pre">H̹̙̦̮͉̩̗̗ͧ̇̏̊̾Eͨ͆͒̆ͮ̃͏̷̮̣̫̤̣Cͯ̂͐͏̨̛͔̦̟͈̻O̜͎͍͙͚̬̝̣̽ͮ͐͗̀ͤ̍̀͢M̴̡̲̭͍͇̼̟̯̦̉̒͠Ḛ̛̙̞̪̗ͥͤͩ̾͑̔͐ͅṮ̴̷̷̗̼͍̿̿̓̽͐H̙̙̔̄͜\u0042:</span> 42 }</tt> is valid ECMAScript 2016</p>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Wikipedia article on string interpolation
( <a class="reference external" href="https://en.wikipedia.org/wiki/String_interpolation">https://en.wikipedia.org/wiki/String_interpolation</a> )</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id13">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>

